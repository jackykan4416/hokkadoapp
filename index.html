<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北海道之旅</title>
    
    <!-- 改用 jsDelivr，連線較穩定 -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        [v-cloak] { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col relative" v-cloak>
        
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur-md shadow-sm z-20 px-4 py-3 flex justify-between items-center sticky top-0">
            <div>
                <h1 class="text-xl font-bold text-sky-600 tracking-wide">Hokkaido Trip ❄️</h1>
                <div class="flex items-center space-x-3 text-xs text-gray-500 mt-1" v-if="weather">
                    <span class="flex items-center"><i class="fas fa-temperature-half mr-1 text-red-400"></i>札幌 {{ weather.current_weather.temperature }}°C</span>
                    <span class="text-gray-300">|</span>
                    <span class="flex items-center text-orange-500 font-medium"><i class="fas fa-cloud-sun mr-1"></i>日落 {{ sunsetTime }}</span>
                </div>
                <p class="text-xs text-gray-400" v-else>載入天氣資訊中...</p>
            </div>
            <button @click="refreshAll" class="p-2 rounded-full hover:bg-gray-100 text-gray-500 transition active:scale-90">
                <i class="fas fa-sync-alt" :class="{'animate-spin': loading}"></i>
            </button>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar bg-gray-50 pb-24 px-4 pt-4">
            
            <!-- Tab 1: 行程 -->
            <transition name="fade" mode="out-in">
                <div v-if="activeTab === 'itinerary'" key="itinerary">
                    <div v-for="(dayItems, dayDate) in groupedItinerary" :key="dayDate" class="mb-6">
                        <div class="sticky top-0 z-10 bg-gray-50/95 backdrop-blur py-2 mb-2 flex items-center shadow-sm px-2 -mx-2">
                            <span class="bg-sky-600 text-white text-xs font-bold px-2 py-1 rounded-md mr-2">{{ getDayOfWeek(dayDate) }}</span>
                            <h2 class="text-lg font-bold text-gray-800">{{ formatDate(dayDate) }}</h2>
                        </div>
                        <div class="space-y-3">
                            <div v-for="(item, index) in dayItems" :key="index" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative overflow-hidden group hover:shadow-md transition-all">
                                <div class="absolute left-0 top-0 bottom-0 w-1" :class="getCategoryColor(item.Category)"></div>
                                <div class="flex items-start">
                                    <div class="flex flex-col items-center mr-4 min-w-[50px]">
                                        <span class="text-sm font-bold text-gray-700">{{ item.Time || '--:--' }}</span>
                                        <div class="h-full w-px bg-gray-200 my-1"></div>
                                        <i :class="[getCategoryIcon(item.Category), 'text-gray-400 text-xs']"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1">{{ item.Activity }}</h3>
                                        <div class="flex items-center text-sm text-gray-500 mb-2">
                                            <i class="fas fa-map-marker-alt text-red-400 mr-1.5 w-4 text-center"></i><span>{{ item.Location || '未指定地點' }}</span>
                                        </div>
                                        <div v-if="item.Note" class="bg-gray-50 rounded-lg p-2 mb-2 text-xs text-gray-600 border border-gray-100 flex items-start">
                                            <i class="fas fa-sticky-note text-amber-400 mr-2 mt-0.5"></i><span class="leading-relaxed">{{ item.Note }}</span>
                                        </div>
                                        <div v-if="item.Link" class="mt-2">
                                            <a :href="item.Link" target="_blank" class="inline-flex items-center text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1.5 rounded-full transition"><i class="fas fa-location-arrow mr-1.5"></i> 導航</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="Object.keys(groupedItinerary).length === 0 && !loading" class="text-center py-10 text-gray-400">
                        <i class="fas fa-calendar-times text-4xl mb-3"></i><p>目前沒有行程資料</p>
                    </div>
                </div>

                <!-- Tab 2: 分帳 -->
                <div v-else-if="activeTab === 'expenses'" key="expenses">
                    <div class="bg-white p-5 rounded-2xl shadow-sm mb-6 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-teal-500"></div>
                        <p class="text-gray-500 text-sm mb-1">總支出 (JPY)</p>
                        <h2 class="text-4xl font-bold text-gray-800">¥{{ totalExpense.toLocaleString() }}</h2>
                        <div class="mt-4 grid grid-cols-5 gap-1 text-xs text-gray-500 border-t pt-3">
                            <div v-for="name in people" :key="name" class="flex flex-col items-center">
                                <span class="font-bold mb-1 scale-90 origin-bottom">{{ name }}</span>
                                <span class="text-emerald-600 scale-90 origin-top">¥{{ getPersonTotal(name).toLocaleString() }}</span>
                            </div>
                        </div>
                    </div>

                    <div v-if="!APPS_SCRIPT_URL" class="bg-red-50 text-red-500 p-3 rounded-xl text-xs mb-4 flex items-center border border-red-100">
                        <i class="fas fa-exclamation-circle mr-2"></i> 請填入 Apps Script 網址以啟用雲端同步
                    </div>

                    <button @click="showExpenseModal = true" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-200 transition transform active:scale-95 mb-6 flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> 記一筆
                    </button>

                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1 flex justify-between items-center">
                        <span>支出紀錄</span>
                        <span v-if="syncingExpenses" class="text-emerald-500 text-xs"><i class="fas fa-circle-notch fa-spin mr-1"></i>同步中...</span>
                    </h3>
                    
                    <div class="space-y-3">
                        <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center animate-[fadeIn_0.3s_ease-out]">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mr-3 font-bold text-xs shrink-0">
                                    {{ exp.payer.charAt(0) }}
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800 line-clamp-1">{{ exp.description }}</h4>
                                    <p class="text-xs text-gray-500">{{ exp.payer }} 先付</p>
                                </div>
                            </div>
                            <div class="text-right shrink-0 ml-2 min-w-[70px]">
                                <span class="block font-bold text-gray-800">¥{{ parseInt(exp.amount).toLocaleString() }}</span>
                                <span class="text-[10px] text-gray-300 block mt-1">{{ formatShortDate(exp.date) }}</span>
                                
                                <!-- 刪除按鈕 (只顯示有 ID 的項目) -->
                                <button v-if="exp.id" @click="deleteExpense(exp)" :disabled="isDeleting === exp.id" class="text-xs text-red-300 hover:text-red-500 mt-1 px-1 py-1 rounded hover:bg-red-50 transition-colors">
                                    <span v-if="isDeleting === exp.id"><i class="fas fa-spinner fa-spin"></i> 刪除中</span>
                                    <span v-else><i class="fas fa-trash-alt mr-1"></i>刪除</span>
                                </button>
                                <!-- 舊資料提示 -->
                                <span v-else class="text-[10px] text-gray-300 block mt-1 bg-gray-100 px-1 rounded">舊資料無法刪除</span>
                            </div>
                        </div>
                        <div v-if="expenses.length === 0 && !syncingExpenses" class="text-center py-8 text-gray-400">
                            <p>還沒有記帳紀錄</p>
                        </div>
                    </div>
                </div>

                <!-- 分頁 3: 資訊 -->
                <div v-else-if="activeTab === 'info'" key="info">
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                        <div class="h-32 bg-sky-100 flex items-center justify-center relative">
                             <img src="https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1000&auto=format&fit=crop" class="absolute w-full h-full object-cover opacity-80" alt="Hokkaido">
                             <h2 class="relative text-2xl font-bold text-white drop-shadow-md">北海道資訊</h2>
                        </div>
                        <div class="p-4">
                            <h3 class="font-bold mb-2">實用連結</h3>
                            <ul class="space-y-2 text-sm text-sky-600">
                                <li><a href="https://www.jrhokkaido.co.jp/" target="_blank" class="flex items-center p-2 bg-sky-50 rounded hover:bg-sky-100"><i class="fas fa-train w-6"></i> JR 北海道時刻表</a></li>
                                <li><a href="https://www.google.com/maps" target="_blank" class="flex items-center p-2 bg-sky-50 rounded hover:bg-sky-100"><i class="fas fa-map-marked-alt w-6"></i> Google Maps</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-bold mb-3">連結狀態</h3>
                        <div class="text-xs text-gray-500 space-y-3">
                             <div class="flex justify-between items-center border-b pb-2">
                                 <span>行程表 (CSV):</span>
                                 <span :class="SHEET_CSV_URL ? 'text-emerald-500 font-bold' : 'text-red-500 font-bold'">
                                     <i :class="SHEET_CSV_URL ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i> {{ SHEET_CSV_URL ? '已連結' : '未設定' }}
                                 </span>
                             </div>
                             <div class="flex justify-between items-center">
                                 <span>分帳同步 (GAS):</span>
                                 <span :class="APPS_SCRIPT_URL ? 'text-emerald-500 font-bold' : 'text-red-500 font-bold'">
                                     <i :class="APPS_SCRIPT_URL ? 'fas fa-check-circle' : 'fas fa-times-circle'"></i> {{ APPS_SCRIPT_URL ? '已連結' : '未設定' }}
                                 </span>
                             </div>
                        </div>
                    </div>
                </div>
            </transition>
        </main>

        <!-- Bottom Nav -->
        <nav class="bg-white shadow-[0_-2px_10px_rgba(0,0,0,0.05)] safe-bottom">
            <div class="flex justify-around items-center">
                <button @click="activeTab = 'itinerary'" class="flex-1 py-3 flex flex-col items-center transition duration-200" :class="activeTab === 'itinerary' ? 'text-sky-600' : 'text-gray-400'"><i class="fas fa-list-ul text-lg mb-1"></i><span class="text-[10px] font-medium">行程</span></button>
                <button @click="activeTab = 'expenses'" class="flex-1 py-3 flex flex-col items-center transition duration-200" :class="activeTab === 'expenses' ? 'text-emerald-500' : 'text-gray-400'"><i class="fas fa-wallet text-lg mb-1"></i><span class="text-[10px] font-medium">分帳</span></button>
                <button @click="activeTab = 'info'" class="flex-1 py-3 flex flex-col items-center transition duration-200" :class="activeTab === 'info' ? 'text-indigo-500' : 'text-gray-400'"><i class="fas fa-info-circle text-lg mb-1"></i><span class="text-[10px] font-medium">資訊</span></button>
            </div>
        </nav>

        <!-- Modal -->
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" @click.self="showExpenseModal = false">
            <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all">
                <h3 class="text-lg font-bold mb-4 text-gray-800">新增支出</h3>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">金額 (JPY)</label><input type="number" v-model="newExpense.amount" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="1000" inputmode="numeric"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">項目說明</label><input type="text" v-model="newExpense.description" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="例如: 拉麵"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">誰先付的？</label><select v-model="newExpense.payer" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-emerald-400"><option v-for="person in people" :key="person" :value="person">{{ person }}</option></select></div>
                </div>
                <div class="mt-6 flex space-x-3">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">取消</button>
                    <button @click="addExpense" :disabled="isSaving" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition shadow-lg shadow-emerald-200 flex justify-center items-center"><span v-if="isSaving"><i class="fas fa-circle-notch fa-spin mr-2"></i>儲存中</span><span v-else>儲存</span></button>
                </div>
            </div>
        </div>

    </div>

    <script>
        if (typeof Vue === 'undefined') { alert('Vue.js 載入失敗。請檢查您的網路連線，或嘗試重新整理頁面。'); }
        if (typeof Papa === 'undefined') { alert('PapaParse 載入失敗。請檢查您的網路連線，或嘗試重新整理頁面。'); }

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                // 行程資料 (CSV)
                const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfauoawYSDrE7095JOlcUtV1CIlpdMQVST7EymMSWce9dEzJ4jj7d1-n9hk-gDoin-SbvWAhVk9-Xe/pub?output=csv'; 
                // 分帳同步 (Google Apps Script)
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby8nFB7hRWh6_rwttT0dbINC6q8m0nYFUSpTdDIIkp5s0em5kjDFLjKYsna5bbUpnOe/exec'; 
                
                // 人員名單
                const people = ['IVAN', 'Hailey', '琳姐', '傑乂', '公數'];

                const activeTab = ref('itinerary');
                const loading = ref(false);
                const syncingExpenses = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(null);
                const itineraryData = ref([]);
                const weather = ref(null);
                const usingMockData = ref(false);
                const showExpenseModal = ref(false);
                const expenses = ref([]);
                const newExpense = ref({ amount: '', description: '', payer: 'IVAN' });

                const fetchItinerary = () => {
                    loading.value = true;
                    if (!SHEET_CSV_URL) { useMockData(); return; }
                    Papa.parse(SHEET_CSV_URL, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (results) => {
                            const validData = results.data.filter(row => row.Date && row.Activity);
                            if(validData.length > 0) { itineraryData.value = validData; usingMockData.value = false; } else { console.log("Empty data"); }
                            loading.value = false;
                        },
                        error: (err) => { console.error(err); loading.value = false; }
                    });
                };

                const useMockData = () => {
                    itineraryData.value = [{ Date: '2025/12/20', Time: '', Location: '新千歲機場', Activity: '抵達！', Note: '範例資料', Category: 'Transport', Link: '' }];
                    usingMockData.value = true;
                    loading.value = false;
                };

                const fetchExpenses = async () => {
                    if (!APPS_SCRIPT_URL) return;
                    syncingExpenses.value = true;
                    try {
                        const res = await fetch(APPS_SCRIPT_URL);
                        const data = await res.json();
                        if (Array.isArray(data)) { expenses.value = data; }
                    } catch (e) { console.error("Sync error", e); } finally { syncingExpenses.value = false; }
                };

                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0618&longitude=141.3545&current_weather=true&daily=sunset&timezone=Asia%2FTokyo');
                        const data = await res.json();
                        weather.value = data;
                    } catch (e) { console.error(e); }
                };

                const addExpense = async () => {
                    if (!newExpense.value.amount || !newExpense.value.description) return;
                    if (!APPS_SCRIPT_URL) { alert("請先設定 Apps Script 網址才能儲存！"); return; }
                    isSaving.value = true;
                    const expenseData = { amount: parseInt(newExpense.value.amount), description: newExpense.value.description, payer: newExpense.value.payer };
                    try {
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(expenseData) });
                        expenses.value.unshift({ ...expenseData, date: new Date().toISOString(), id: 'temp-' + Date.now() });
                        newExpense.value = { amount: '', description: '', payer: 'IVAN' };
                        showExpenseModal.value = false;
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("儲存失敗，請檢查網路連線"); console.error(e); } finally { isSaving.value = false; }
                };

                const deleteExpense = async (item) => {
                    if (!item.id) { alert("此項目尚未同步完成，或為舊資料無法刪除"); return; }
                    if (!confirm(`確定要刪除「${item.description}」嗎？`)) return;
                    isDeleting.value = item.id;
                    try {
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'delete', id: item.id }) });
                        expenses.value = expenses.value.filter(e => e.id !== item.id);
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("刪除失敗，請檢查網路"); console.error(e); } finally { isDeleting.value = null; }
                };

                const refreshAll = () => { fetchItinerary(); fetchExpenses(); fetchWeather(); };

                const sunsetTime = computed(() => {
                    if (!weather.value || !weather.value.daily || !weather.value.daily.sunset) return '';
                    return weather.value.daily.sunset[0].split('T')[1];
                });

                const groupedItinerary = computed(() => {
                    const groups = {};
                    itineraryData.value.forEach(item => {
                        const dateKey = item.Date.trim();
                        if (!groups[dateKey]) groups[dateKey] = [];
                        groups[dateKey].push(item);
                    });
                    return Object.keys(groups).sort().reduce((acc, date) => { acc[date] = groups[date]; return acc; }, {});
                });

                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (parseInt(item.amount)||0), 0));
                const getPersonTotal = (name) => { return expenses.value.filter(e => e.payer === name).reduce((sum, e) => sum + (parseInt(e.amount)||0), 0); };

                const getCategoryColor = (cat) => {
                    if (!cat) return 'bg-gray-300';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('食')) return 'bg-orange-400';
                    if (c.includes('transport') || c.includes('行') || c.includes('車')) return 'bg-blue-400';
                    if (c.includes('sight') || c.includes('景')) return 'bg-emerald-400';
                    if (c.includes('shop') || c.includes('買')) return 'bg-pink-400';
                    return 'bg-sky-400';
                };

                const getCategoryIcon = (cat) => {
                    if (!cat) return 'fas fa-circle';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('食')) return 'fas fa-utensils';
                    if (c.includes('transport') || c.includes('行') || c.includes('車')) return 'fas fa-train';
                    if (c.includes('sight') || c.includes('景')) return 'fas fa-camera';
                    if (c.includes('shop') || c.includes('買')) return 'fas fa-shopping-bag';
                    return 'fas fa-map-pin';
                };

                const formatDate = (dateStr) => { try { const d = new Date(dateStr); return `${d.getMonth() + 1}月${d.getDate()}日`; } catch (e) { return dateStr; } };
                const formatShortDate = (dateStr) => { if(!dateStr) return ''; try { const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()}`; } catch (e) { return ''; } }
                const getDayOfWeek = (dateStr) => { try { return ['週日', '週一', '週二', '週三', '週四', '週五', '週六'][new Date(dateStr).getDay()]; } catch (e) { return ''; } };

                onMounted(() => { refreshAll(); });

                return {
                    people, activeTab, loading, weather, sunsetTime, groupedItinerary, expenses,
                    totalExpense, showExpenseModal, newExpense, addExpense, deleteExpense, refreshAll, syncingExpenses, isSaving, isDeleting,
                    formatDate, formatShortDate, getDayOfWeek, getCategoryColor, getCategoryIcon, 
                    SHEET_CSV_URL, APPS_SCRIPT_URL, getPersonTotal, usingMockData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>