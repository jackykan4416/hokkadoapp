<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—æµ·é“å†¬ä¹‹æ—…</title>
    
    <!-- ä½¿ç”¨ jsDelivr è¼‰å…¥ Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #4A7C9D;
            --color-primary-dark: #375D75;
            --color-bg: #F0F8FF;
            --color-text: #2C3E50;
        }

        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: var(--color-bg);
            background-image: radial-gradient(#CBD5E0 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--color-text);
            -webkit-tap-highlight-color: transparent; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        [v-cloak] { display: none !important; }
        
        .floating-nav {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 92%;
            max-width: 400px;
            border-radius: 999px;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(16px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 40;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .card-rounded { border-radius: 20px; }
        
        .banner-enter-active, .banner-leave-active { transition: opacity 0.5s ease; }
        .banner-enter-from, .banner-leave-to { opacity: 0; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col relative" v-cloak>
        
        <!-- Header -->
        <header class="relative w-full h-[250px] shadow-md z-20 flex-shrink-0 bg-slate-200">
            <transition name="banner">
                <img 
                    :key="bannerImage"
                    :src="bannerImage" 
                    onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1548263594-a71ea65a8598?auto=format&fit=crop&q=80&w=1920';"
                    alt="Header Banner" 
                    class="absolute inset-0 w-full h-full object-cover object-center z-0 transition-opacity duration-500"
                >
            </transition>
            
            <div class="absolute inset-0 bg-white/5 z-10"></div>

            <!-- æ¨™é¡Œèˆ‡é‡æ–°æ•´ç† -->
            <div class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-20">
                <h1 class="text-3xl font-black tracking-wider flex items-center text-[var(--color-primary)] drop-shadow-md bg-white/20 px-3 py-1 rounded-xl backdrop-blur-md border border-white/20">
                    <i class="fas fa-snowflake text-sky-500 mr-2 animate-pulse text-2xl"></i>
                    Hokkaido
                </h1>
                
                <button @click="refreshAll" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/30 text-slate-700 hover:bg-white/50 transition active:scale-90 shadow-md backdrop-blur-md border border-white/20">
                    <i class="fas fa-sync-alt" :class="{'animate-spin': loading}"></i>
                </button>
            </div>

            <!-- åº•éƒ¨è³‡è¨Šåˆ— -->
            <div class="absolute bottom-4 left-0 w-full px-4 z-20">
                
                <!-- ä¸­é–“ï¼šWeathernews -->
                <div class="absolute left-1/2 transform -translate-x-1/2 bottom-0" v-if="weather">
                    <a href="https://weathernews.jp/onebox/43.06417/141.34694/temp=c" target="_blank" class="text-[10px] text-slate-700 hover:text-[var(--color-primary)] transition flex items-center bg-white/80 px-3 py-1.5 rounded-full border border-white/50 font-bold shadow-sm whitespace-nowrap backdrop-blur-sm">
                        Weathernews <i class="fas fa-external-link-alt ml-1"></i>
                    </a>
                </div>

                <div class="flex justify-between items-end w-full">
                    <!-- å·¦ä¸‹ï¼šæº«åº¦ + æ—¥è½ -->
                    <div class="flex items-center space-x-1.5 text-xs text-slate-800 font-bold" v-if="weather">
                        <span class="flex items-center bg-white/80 px-2 py-1 rounded-lg shadow-sm backdrop-blur-sm">
                            <i class="fas fa-temperature-low mr-1 text-[var(--color-primary)]"></i>{{ weather.current_weather.temperature }}Â°
                        </span>
                        <span class="flex items-center text-orange-700 bg-white/80 px-2 py-1 rounded-lg shadow-sm backdrop-blur-sm">
                            <i class="fas fa-cloud-sun mr-1"></i>{{ sunsetTime }}
                        </span>
                    </div>
                    <div v-else class="bg-white/60 px-2 py-1 rounded-lg text-xs font-bold text-slate-500 backdrop-blur-sm">
                        <i class="fas fa-circle-notch fa-spin mr-1"></i>è®€å–ä¸­...
                    </div>

                    <!-- å³ä¸‹ï¼šå€’æ•¸è¨ˆæ™‚ -->
                    <div class="mb-0.5">
                        <span class="bg-[var(--color-primary)]/90 text-white text-[10px] font-bold px-2.5 py-1.5 rounded-lg shadow-lg backdrop-blur-sm flex items-center border border-white/20">
                            <i class="fas fa-hourglass-half mr-1.5 text-yellow-300"></i> 
                            <span class="mr-0.5">é‚„å‰©</span>
                            <span class="text-sm font-black mx-0.5">{{ countdown }}</span>
                            <span>å¤©</span>
                        </span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar pb-32 px-4 pt-6">
            
            <transition name="slide-up" mode="out-in">
                <!-- Tab 1: è¡Œç¨‹ -->
                <div v-if="activeTab === 'itinerary'" key="itinerary" class="flex flex-col h-full">
                    <div v-if="dateKeys.length > 0" class="flex space-x-2 overflow-x-auto no-scrollbar pb-4 px-1 flex-shrink-0">
                        <button v-for="date in dateKeys" :key="date" @click="selectedDay = date" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border" :class="selectedDay === date ? 'bg-[var(--color-primary)] text-white border-transparent shadow-md' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'">{{ formatShortDate(date) }}</button>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar pb-24" ref="itineraryContainer">
                        <div v-if="selectedDay && groupedItinerary[selectedDay]" class="space-y-0">
                            <div class="flex items-center mb-6 mt-2 ml-2">
                                <div><h2 class="text-2xl font-bold text-slate-700 tracking-wide">{{ formatDate(selectedDay) }}</h2><span class="text-slate-400 text-xs font-bold bg-slate-100 px-2 py-0.5 rounded mt-1 inline-block">{{ getDayOfWeek(selectedDay) }}</span></div>
                            </div>

                            <div v-for="(item, index) in groupedItinerary[selectedDay]" :key="index" class="relative pl-2 pb-2">
                                <div v-if="index > 0 && (item.Transport || item.Duration)" class="flex items-center justify-center mb-8 ml-8 relative z-0">
                                    <div class="bg-slate-100 text-slate-600 px-6 py-3 rounded-full text-base font-bold flex items-center border-2 border-slate-200 z-10 shadow-sm">
                                        <span class="mr-3 text-2xl" v-if="item.Transport && item.Transport.includes('è»Š')">ğŸš—</span>
                                        <span class="mr-3 text-2xl" v-else-if="item.Transport && (item.Transport.includes('èµ°') || item.Transport.includes('æ­¥'))">ğŸš¶</span>
                                        <span class="mr-3 text-2xl" v-else-if="item.Transport && (item.Transport.includes('JR') || item.Transport.includes('éµ'))">ğŸšƒ</span>
                                        <span v-if="item.Transport" class="mr-1">{{ item.Transport }}</span>
                                        <span v-if="item.Duration" class="text-slate-400 border-l-2 border-slate-300 pl-3 ml-2">{{ item.Duration }}</span>
                                    </div>
                                    <div class="absolute top-[-30px] bottom-[-30px] left-1/2 w-1 bg-slate-200 -z-10 h-[calc(100%+60px)]"></div>
                                </div>

                                <div class="bg-white card-rounded shadow-sm p-5 relative overflow-hidden transition-all mb-6 border-l-[6px]" :class="getCategoryBorderClass(item.Category)">
                                    <div class="flex items-start pl-1">
                                        <div class="flex flex-col items-center mr-5 pt-1 min-w-[45px]">
                                            <div class="w-10 h-10 rounded-full flex items-center justify-center border shadow-sm mb-1" :class="getCategoryIconClass(item.Category)"><i :class="getCategoryIcon(item.Category)"></i></div>
                                        </div>
                                        <div class="flex-1 pl-1">
                                            <div class="flex justify-between items-start mb-3">
                                                <h3 class="font-bold text-slate-800 text-lg leading-snug mr-2">{{ item.Activity }}</h3>
                                                <div class="bg-orange-100 text-orange-600 px-3 py-1 rounded-lg font-black text-sm shadow-sm whitespace-nowrap border border-orange-200">{{ item.Time || '--:--' }}</div>
                                            </div>
                                            <div class="flex items-center text-xs text-slate-500 mb-3 font-bold"><i class="fas fa-map-marker-alt text-red-400 mr-1.5"></i><span>{{ item.Location || 'æœªæŒ‡å®šåœ°é»' }}</span></div>
                                            <div v-if="item.MapCode" class="mb-3"><div class="bg-[var(--color-bg)] px-3 py-2 rounded-xl flex items-center border border-slate-100"><i class="fas fa-car-side text-[var(--color-primary)] mr-3 text-lg opacity-80"></i><div class="flex flex-col"><span class="text-[9px] text-slate-400 uppercase tracking-wider font-bold">NAVI / MAPCODE</span><span class="font-mono text-base font-bold text-slate-700 tracking-wide">{{ item.MapCode }}</span></div></div></div>
                                            <div v-if="getFoodRecommendation(item)" class="bg-yellow-50 rounded-xl p-3 mb-3 border border-yellow-100"><div class="flex items-start"><span class="text-xl mr-2">ğŸ’¡</span><div><span class="text-[10px] text-yellow-600 font-black uppercase tracking-wider block mb-0.5">é¥•å®¢æ¨è–¦</span><span class="text-sm text-slate-700 font-bold leading-relaxed">{{ getFoodRecommendation(item) }}</span></div></div></div>
                                            <div v-if="item.Note" class="bg-slate-50 rounded-xl p-3 mb-3 text-sm text-slate-600 flex items-start border border-slate-100"><span class="text-slate-400 mr-2 mt-0.5">â—</span><span class="leading-relaxed text-xs break-all">{{ item.Note }}</span></div>
                                            <div v-if="item.Link" class="mt-2 flex justify-end"><a :href="item.Link" target="_blank" class="inline-flex justify-center items-center text-xs font-bold text-[var(--color-primary)] border border-[var(--color-primary)] px-4 py-1.5 rounded-full hover:bg-[var(--color-primary)] hover:text-white transition"><i class="fas fa-location-arrow mr-2"></i> å°èˆª</a></div>
                                            <div class="mt-4 pt-3 border-t border-slate-100"><div class="relative"><i class="fas fa-pen absolute left-3 top-3 text-yellow-500/50 text-xs"></i><textarea v-model="memos[getItemKey(item)]" @input="saveMemos" class="w-full bg-yellow-50/50 border border-yellow-100 rounded-xl py-2 pl-8 pr-3 text-sm text-slate-600 focus:outline-none focus:ring-2 focus:ring-yellow-200 resize-none transition-shadow" rows="1" placeholder="éš¨æ‰‹è¨˜ (Memo)..." @focus="$event.target.rows = 3" @blur="$event.target.value === '' ? $event.target.rows = 1 : $event.target.rows = 3"></textarea></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="dateKeys.length === 0 && !loading" class="text-center py-20 text-slate-300"><i class="far fa-snowflake text-5xl mb-4 opacity-50"></i><p>æ²’æœ‰è¡Œç¨‹è³‡æ–™</p></div>
                    </div>
                </div>

                <!-- Tab 2: åˆ†å¸³ -->
                <div v-else-if="activeTab === 'expenses'" key="expenses">
                    <div class="bg-white p-5 rounded-2xl shadow-sm mb-4 border border-slate-100 mx-1 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10 relative">
                            <div><p class="text-xs text-slate-400 font-bold tracking-widest mb-1">PUBLIC FUND</p><h3 class="text-lg font-black text-slate-700">å…¬æ•¸é¤˜é¡</h3></div>
                            <div class="text-right"><h2 class="text-3xl font-black tracking-tight font-mono" :class="publicFundBalance >= 0 ? 'text-sky-600' : 'text-red-500'">Â¥{{ publicFundBalance.toLocaleString() }}</h2></div>
                        </div>
                        <div class="absolute right-0 bottom-0 opacity-5 text-8xl text-sky-500 rotate-12 -mb-4 -mr-4"><i class="fas fa-coins"></i></div>
                    </div>

                    <div class="bg-gradient-to-br from-slate-700 to-slate-800 p-6 card-rounded shadow-xl mb-6 text-center text-white relative overflow-hidden mx-1">
                        <p class="text-slate-300 text-xs mb-1 font-bold tracking-widest uppercase">Total Expenses</p>
                        <h2 class="text-5xl font-black mb-6 tracking-tight font-mono">Â¥{{ totalExpense.toLocaleString() }}</h2>
                        <div class="grid grid-cols-5 gap-2 text-white pt-4 border-t border-slate-600">
                            <div v-for="name in people" :key="name" class="flex flex-col items-center"><span class="font-bold mb-1 opacity-90 text-xs">{{ name }}</span><span class="bg-white/10 px-1 py-1.5 rounded-lg w-full text-center text-sm font-bold tracking-wide">Â¥{{ getPersonTotal(name).toLocaleString() }}</span></div>
                        </div>
                    </div>
                    <div v-if="!APPS_SCRIPT_URL" class="bg-red-50 text-red-500 p-4 rounded-2xl text-xs mb-4 flex items-center border border-red-100 mx-1"><i class="fas fa-exclamation-triangle mr-3 text-lg"></i> è«‹å¡«å…¥ Apps Script ç¶²å€</div>
                    <div class="flex gap-2 mb-6 mx-1">
                        <button @click="openEditModal()" class="flex-1 bg-[var(--color-primary)] hover:bg-[var(--color-primary-dark)] text-white font-bold py-4 rounded-2xl shadow-lg transition transform active:scale-95 flex items-center justify-center text-lg"><i class="fas fa-plus mr-2"></i> è¨˜ä¸€ç­†</button>
                        <button @click="calculateSettlement" class="w-16 bg-indigo-100 text-indigo-600 hover:bg-indigo-200 font-bold rounded-2xl shadow-sm transition flex items-center justify-center flex-col text-xs"><i class="fas fa-calculator text-xl mb-1"></i> çµç®—</button>
                    </div>
                    <div class="space-y-4 pb-24 px-1">
                        <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-5 card-rounded shadow-sm flex justify-between items-center border border-slate-50">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center mr-4 font-black text-sm shrink-0" :class="isDeposit(exp) ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'">{{ isDeposit(exp) ? 'å…¥' : exp.payer.charAt(0) }}</div>
                                <div><h4 class="font-bold text-base line-clamp-1" :class="isDeposit(exp) ? 'text-emerald-600' : 'text-slate-800'">{{ exp.description }}</h4><p class="text-xs font-bold mt-0.5" :class="isDeposit(exp) ? 'text-emerald-400' : 'text-slate-400'">{{ exp.payer }} {{ isDeposit(exp) ? 'æ³¨å…¥' : 'å…ˆä»˜' }}</p></div>
                            </div>
                            <div class="text-right shrink-0 ml-3 min-w-[80px]">
                                <span class="block font-black text-lg" :class="isDeposit(exp) ? 'text-emerald-500' : 'text-[var(--color-primary)]'">{{ isDeposit(exp) ? '+' : '' }}Â¥{{ parseInt(exp.amount).toLocaleString() }}</span><span class="text-[10px] text-slate-300 block mt-0.5 mb-1">{{ formatShortDate(exp.date) }}</span>
                                
                                <div class="flex justify-end gap-2 mt-2">
                                     <button v-if="exp.id" @click="openEditModal(exp)" class="text-xs text-sky-400 hover:text-sky-600 px-2 py-1 bg-sky-50 rounded-lg transition font-bold"><i class="fas fa-pen"></i></button>
                                     <button v-if="exp.id" @click="deleteExpense(exp)" :disabled="isDeleting === exp.id" class="text-xs text-red-400 hover:text-red-600 px-2 py-1 bg-red-50 rounded-lg transition font-bold"><span v-if="isDeleting === exp.id"><i class="fas fa-spinner fa-spin"></i></span><span v-else><i class="fas fa-trash"></i></span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: å·¥å…· -->
                <div v-else-if="activeTab === 'tools'" key="tools">
                    <div class="flex p-1 bg-white rounded-xl mb-4 mx-1 border border-slate-200"><button v-for="tab in ['packing', 'shopping', 'phrase', 'car']" :key="tab" @click="toolSubTab = tab" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all" :class="toolSubTab === tab ? 'bg-[var(--color-primary)] text-white shadow-sm' : 'text-slate-400'"><span v-if="tab==='packing'">ğŸ’ è¡Œæ</span><span v-else-if="tab==='shopping'">ğŸ ä»£è³¼</span><span v-else-if="tab==='phrase'">ğŸ—£ï¸ æ—¥èª</span><span v-else>ğŸ…¿ï¸ åœè»Š</span></button></div>
                    <div v-if="toolSubTab === 'packing'" class="pb-24"><div class="bg-white card-rounded p-5 border border-slate-50 mx-1"><h3 class="font-bold text-slate-700 mb-4 flex items-center"><i class="fas fa-suitcase-rolling mr-2 text-[var(--color-primary)]"></i> é›ªåœ‹è‡ªé§•å¿…å‚™</h3><div class="space-y-3"><div v-for="(item, idx) in packingList" :key="idx" class="flex items-center p-3 rounded-xl border transition-all" :class="item.checked ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-200'" @click="togglePacking(idx)"><div class="w-6 h-6 rounded-full border-2 flex items-center justify-center mr-3 transition-colors" :class="item.checked ? 'bg-emerald-400 border-emerald-400 text-white' : 'border-slate-300'"><i class="fas fa-check text-xs" v-if="item.checked"></i></div><span class="text-sm font-bold" :class="item.checked ? 'text-slate-400 line-through' : 'text-slate-700'">{{ item.text }}</span></div></div></div></div>
                    
                    <!-- ä»£è³¼æ¸…å–® -->
                    <div v-else-if="toolSubTab === 'shopping'" class="pb-24">
                        <div class="bg-white p-5 rounded-2xl mb-4 border border-slate-100 shadow-sm mx-1">
                            <input v-model="newShopItem.text" type="text" placeholder="è¼¸å…¥å•†å“åç¨±..." class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 text-base font-bold focus:ring-2 focus:ring-[var(--color-primary)] focus:outline-none mb-4 transition-shadow">
                            <div class="flex gap-3">
                                <input v-model="newShopItem.who" type="text" placeholder="è²·çµ¦èª°?" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-4 text-base font-bold text-center focus:ring-2 focus:ring-[var(--color-primary)] focus:outline-none transition-shadow">
                                <button @click="addShopItem" class="bg-[var(--color-primary)] hover:bg-[var(--color-primary-dark)] text-white w-24 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center">
                                    <i class="fas fa-plus text-xl"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-3 mx-1">
                            <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white card-rounded p-4 border border-slate-50 flex justify-between items-center shadow-sm"><div class="flex items-center w-full" @click="toggleShop(idx)"><div class="w-5 h-5 rounded border-2 mr-3 flex items-center justify-center shrink-0" :class="item.checked ? 'bg-emerald-400 border-emerald-400 text-white' : 'border-slate-300'"><i class="fas fa-check text-[10px]" v-if="item.checked"></i></div><div class="flex-1 min-w-0"><div class="font-bold text-slate-700 truncate" :class="{'line-through text-slate-400': item.checked}">{{ item.text }}</div><div class="text-[10px] text-slate-400 bg-slate-100 px-2 py-0.5 rounded w-max mt-1">To: {{ item.who }}</div></div></div><button @click="removeShopItem(idx)" class="text-slate-300 hover:text-red-400 px-2 ml-2"><i class="fas fa-trash-alt"></i></button></div><div v-if="shoppingList.length === 0" class="text-center text-slate-400 py-10 text-xs">å°šç„¡æ¸…å–®ï¼Œå¿«å»è²·è²·è²·ï¼</div></div>
                    </div>
                    
                    <div v-else-if="toolSubTab === 'phrase'" class="pb-24"><div class="grid grid-cols-2 gap-3 mx-1"><div v-for="(phrase, idx) in phrasebook" :key="idx" class="bg-white card-rounded p-4 border border-slate-50 shadow-sm active:scale-95 transition cursor-pointer hover:border-[var(--color-primary)]" @click="showPhraseModal(phrase)"><div class="text-xs text-slate-400 mb-1">{{ phrase.cat }}</div><div class="font-black text-slate-700 text-lg mb-1">{{ phrase.cn }}</div><div class="text-[10px] text-[var(--color-primary)]">{{ phrase.pron }}</div></div></div></div>
                    <div v-else-if="toolSubTab === 'car'" class="pb-24"><div class="bg-white card-rounded p-6 border border-slate-50 shadow-sm mx-1"><h3 class="font-bold text-slate-800 mb-4 flex items-center"><i class="fas fa-car mr-2 text-[var(--color-primary)]"></i> åœè»Š/ç§Ÿè»Šç´€éŒ„</h3><div class="mb-4"><label class="block text-xs font-bold text-slate-400 mb-1">è»Šç‰Œè™Ÿç¢¼</label><input v-model="carInfo.plate" @input="saveCarInfo" class="w-full bg-slate-50 border-2 border-slate-200 rounded-xl p-4 text-center text-3xl font-black text-slate-700 tracking-widest uppercase focus:border-[var(--color-primary)] focus:outline-none" placeholder="12-34"></div><div class="flex gap-3 mb-4"><div class="flex-1"><label class="block text-xs font-bold text-slate-400 mb-1">æ¨“å±¤ Floor</label><input v-model="carInfo.floor" @input="saveCarInfo" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-center font-bold text-slate-700 focus:border-[var(--color-primary)] focus:outline-none" placeholder="B1"></div><div class="flex-1"><label class="block text-xs font-bold text-slate-400 mb-1">å€åŸŸ Zone</label><input v-model="carInfo.zone" @input="saveCarInfo" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-center font-bold text-slate-700 focus:border-[var(--color-primary)] focus:outline-none" placeholder="Gå€"></div></div><div><label class="block text-xs font-bold text-slate-400 mb-1">å‚™è¨»</label><textarea v-model="carInfo.note" @input="saveCarInfo" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-700 focus:border-[var(--color-primary)] focus:outline-none" rows="3" placeholder="ä¾‹å¦‚ï¼šåœåœ¨é›»æ¢¯å£é™„è¿‘..."></textarea></div></div></div>
                </div>

                <!-- Tab 4: è³‡è¨Š -->
                <div v-else-if="activeTab === 'info'" key="info">
                    <!-- 1. å¯¦æ™‚åŒ¯ç‡ -->
                    <div class="bg-white card-rounded shadow-sm p-6 mb-6 border border-slate-50 mt-2 mx-1 relative overflow-hidden">
                        <h3 class="font-bold text-[var(--color-primary)] mb-4 flex items-center text-lg"><i class="fas fa-coins text-yellow-400 mr-3 text-xl"></i> å¯¦æ™‚åŒ¯ç‡</h3>
                        <div class="flex items-center space-x-3 mb-3 relative z-10">
                            <div class="flex-1 bg-[var(--color-bg)] rounded-2xl p-4">
                                <label class="block text-[10px] text-slate-400 mb-1 font-black tracking-widest">HKD</label>
                                <input type="number" v-model="calcHkd" @input="updateFromHkd" class="w-full bg-transparent border-none p-0 text-2xl font-black text-slate-700 focus:ring-0 placeholder-slate-300 font-mono" placeholder="0">
                            </div>
                            <i class="fas fa-exchange-alt text-slate-300 text-xl"></i>
                            <div class="flex-1 bg-[var(--color-bg)] rounded-2xl p-4">
                                <label class="block text-[10px] text-slate-400 mb-1 font-black tracking-widest">JPY</label>
                                <input type="number" v-model="calcJpy" @input="updateFromJpy" class="w-full bg-transparent border-none p-0 text-2xl font-black text-slate-700 focus:ring-0 placeholder-slate-300 font-mono" placeholder="0">
                            </div>
                        </div>
                        <div class="text-right text-xs text-slate-400 font-bold px-1"><span v-if="exchangeRate">1 HKD â‰ˆ {{ exchangeRate.toFixed(2) }} JPY</span><span v-else><i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</span></div>
                    </div>

                    <!-- 2. èˆªç­è³‡è¨Š -->
                    <div class="bg-white card-rounded shadow-sm mb-6 overflow-hidden border border-slate-50 mx-1">
                        <div class="bg-[var(--color-primary)] px-6 py-4 flex justify-between items-center"><h3 class="text-white font-bold text-base tracking-wide"><i class="fas fa-plane-departure mr-3"></i>èˆªç­è³‡è¨Š</h3><span class="text-white/80 text-[10px] bg-white/20 px-3 py-1 rounded-full font-bold">HK Airlines</span></div>
                        <div class="p-6 space-y-8">
                            <div class="flex items-center justify-between relative"><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">HKG</div><div class="text-xs text-white font-bold bg-slate-400 rounded-lg px-2 py-1 mt-1 inline-block">08:35</div></div><div class="text-center w-1/3 flex flex-col items-center px-2"><div class="text-[10px] text-slate-400 font-bold mb-1">HX690</div><div class="w-full flex items-center"><div class="h-[2px] bg-slate-200 w-full rounded-full"></div><i class="fas fa-plane text-slate-300 mx-2 text-sm"></i><div class="h-[2px] bg-slate-200 w-full rounded-full"></div></div><div class="text-[10px] text-slate-400 mt-1 font-bold">5h 45m</div></div><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">CTS</div><div class="text-xs text-white font-bold bg-[var(--color-primary)] rounded-lg px-2 py-1 mt-1 inline-block">14:20</div></div></div>
                            <div class="flex items-center justify-between relative"><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">CTS</div><div class="text-xs text-white font-bold bg-[var(--color-primary)] rounded-lg px-2 py-1 mt-1 inline-block">16:15</div></div><div class="text-center w-1/3 flex flex-col items-center px-2"><div class="text-[10px] text-slate-400 font-bold mb-1">HX693</div><div class="w-full flex items-center"><div class="h-[2px] bg-slate-200 w-full rounded-full"></div><i class="fas fa-plane text-slate-300 mx-2 text-sm transform rotate-180"></i><div class="h-[2px] bg-slate-200 w-full rounded-full"></div></div><div class="text-[10px] text-slate-400 mt-1 font-bold">6h 45m</div></div><div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">HKG</div><div class="text-xs text-white font-bold bg-slate-400 rounded-lg px-2 py-1 mt-1 inline-block">22:00</div></div></div>
                        </div>
                    </div>

                    <!-- 3. ç·Šæ€¥æ•‘æ´ -->
                    <div class="bg-red-50 card-rounded shadow-sm mb-6 border border-red-100 mx-1 p-5 relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-red-100 text-8xl opacity-50 rotate-12"><i class="fas fa-ambulance"></i></div>
                        <h3 class="font-bold text-red-700 mb-4 flex items-center relative z-10"><i class="fas fa-exclamation-circle mr-2 animate-pulse"></i> ç·Šæ€¥æ•‘æ´ / é“è·¯æƒ…å ±</h3>
                        <div class="grid grid-cols-3 gap-2 mb-4 relative z-10">
                            <a href="tel:110" class="bg-white border border-red-200 p-3 rounded-xl flex flex-col items-center justify-center hover:bg-red-100 transition text-center"><i class="fas fa-user-shield text-xl text-red-500 mb-1"></i><span class="text-xs font-black text-red-700">è­¦å¯Ÿ 110</span></a>
                            <a href="tel:119" class="bg-white border border-red-200 p-3 rounded-xl flex flex-col items-center justify-center hover:bg-red-100 transition text-center"><i class="fas fa-ambulance text-xl text-red-500 mb-1"></i><span class="text-xs font-black text-red-700">æ•‘è­· 119</span></a>
                            <a href="tel:#8139" class="bg-white border border-red-200 p-3 rounded-xl flex flex-col items-center justify-center hover:bg-red-100 transition text-center"><i class="fas fa-tools text-xl text-red-500 mb-1"></i><span class="text-xs font-black text-red-700">JAF #8139</span></a>
                        </div>
                        <div class="space-y-2 relative z-10">
                             <a href="https://info-road.hdb.hkd.mlit.go.jp/en/" target="_blank" class="block bg-white hover:bg-red-50 p-3 rounded-xl transition border border-red-100"><div class="flex justify-between items-center"><span class="text-sm font-bold text-slate-700"><i class="fas fa-video text-slate-400 mr-2"></i> è·¯æ³æ”å½±æ©Ÿ (Live)</span><i class="fas fa-external-link-alt text-xs text-slate-400"></i></div></a>
                            <a href="http://northern-road.jp/navi/eng/" target="_blank" class="block bg-white hover:bg-red-50 p-3 rounded-xl transition border border-red-100"><div class="flex justify-between items-center"><span class="text-sm font-bold text-slate-700"><i class="fas fa-route text-slate-400 mr-2"></i> åŒ—ä¹‹é“å°èˆª (å†¬å­£æ™‚é–“)</span><i class="fas fa-external-link-alt text-xs text-slate-400"></i></div></a>
                        </div>
                    </div>

                    <!-- 4. ä½å®¿æ¸…å–® -->
                    <div class="bg-white card-rounded shadow-sm mb-6 border border-slate-50 mx-1">
                        <div class="px-6 py-5 border-b border-slate-50 flex items-center"><div class="bg-indigo-50 p-2 rounded-lg mr-3"><i class="fas fa-bed text-indigo-500"></i></div><h3 class="font-bold text-slate-800 text-lg">ä½å®¿æ¸…å–®</h3></div>
                        <div class="divide-y divide-slate-50">
                            <div v-for="(hotel, index) in hotelList" :key="index" class="p-5 hover:bg-slate-50 transition">
                                <div class="flex justify-between items-start mb-2"><span class="bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black tracking-wide">{{ hotel.nights }}</span></div>
                                <h4 class="font-bold text-slate-700 text-base mb-4 leading-tight">{{ hotel.name }}</h4>
                                <a :href="'tel:' + hotel.phone" class="flex items-center justify-center w-full text-sm text-slate-500 bg-[var(--color-bg)] px-4 py-3 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition font-bold border border-transparent hover:border-indigo-100"><i class="fas fa-phone-alt mr-3"></i> {{ hotel.phone }}</a>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>
        </main>

        <!-- æµ®å‹•å°èˆªæ¢ -->
        <nav class="floating-nav flex justify-between items-center py-2 px-6">
            <button @click="activeTab = 'itinerary'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'itinerary' ? 'text-white' : 'text-slate-500'"><i class="fas fa-calendar-alt text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
            <button @click="activeTab = 'expenses'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'expenses' ? 'text-emerald-400' : 'text-slate-500'"><i class="fas fa-wallet text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">åˆ†å¸³</span></button>
            <button @click="activeTab = 'tools'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'tools' ? 'text-yellow-400' : 'text-slate-500'"><i class="fas fa-briefcase text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">å·¥å…·</span></button>
            <button @click="activeTab = 'info'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'info' ? 'text-indigo-400' : 'text-slate-500'"><i class="fas fa-book-open text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">è³‡è¨Š</span></button>
        </nav>

        <!-- Expense Modal (æ›´æ–°ç‰ˆ) -->
        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" @click.self="showExpenseModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-8 shadow-2xl transform transition-all border border-white">
                <h3 class="text-xl font-bold mb-8 text-slate-800 flex items-center">
                    <i class="fas fa-edit mr-3 text-[var(--color-primary)]"></i>
                    {{ isEditing ? 'ç·¨è¼¯æ”¯å‡º' : (expenseMode === 'expense' ? 'æ–°å¢æ”¯å‡º' : 'å…¬è²»å…¥é‡‘') }}
                </h3>
                <!-- æ”¯å‡º/å…¥é‡‘ åˆ‡æ› (åƒ…åœ¨æ–°å¢æ¨¡å¼é¡¯ç¤º) -->
                <div class="flex p-1 bg-slate-100 rounded-xl mb-6" v-if="!isEditing">
                    <button @click="switchExpenseMode('expense')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all" :class="expenseMode === 'expense' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'">æ”¯å‡º</button>
                    <button @click="switchExpenseMode('deposit')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all" :class="expenseMode === 'deposit' ? 'bg-emerald-100 text-emerald-700 shadow-sm' : 'text-slate-400'">å…¥é‡‘</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">é‡‘é¡ (JPY)</label>
                        <input type="number" v-model="newExpense.amount" class="w-full bg-[var(--color-bg)] border-none rounded-2xl p-4 text-xl text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition font-mono" placeholder="1000" inputmode="numeric">
                    </div>
                    <div v-if="expenseMode === 'expense' || isEditing">
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">é …ç›®èªªæ˜</label>
                        <input type="text" v-model="newExpense.description" class="w-full bg-[var(--color-bg)] border-none rounded-2xl p-4 text-base text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition" placeholder="ä¾‹å¦‚: æ‹‰éºµ">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">{{ (expenseMode === 'expense' || isEditing) ? 'èª°å…ˆä»˜çš„ï¼Ÿ' : 'èª°ç¹³å…¬è²»ï¼Ÿ' }}</label>
                        <div class="relative">
                            <select v-model="newExpense.payer" class="w-full bg-[var(--color-bg)] border-none rounded-2xl p-4 text-base text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] appearance-none">
                                <option v-for="person in people" :key="person" :value="person">{{ person }}</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-5 top-5 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
                <div class="mt-10 flex space-x-4">
                    <button @click="showExpenseModal = false" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition">å–æ¶ˆ</button>
                    <button @click="submitExpense" :disabled="isSaving" class="flex-1 py-4 text-white rounded-2xl font-bold hover:opacity-90 transition shadow-lg shadow-blue-900/20 flex justify-center items-center" :class="(expenseMode === 'expense' || isEditing) ? 'bg-[var(--color-primary)]' : 'bg-emerald-500'">
                        <span v-if="isSaving"><i class="fas fa-circle-notch fa-spin mr-2"></i>å„²å­˜ä¸­</span>
                        <span v-else>{{ isEditing ? 'æ›´æ–°' : 'å„²å­˜' }}</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div v-if="showSettlementModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm" @click.self="showSettlementModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-6 shadow-2xl transform transition-all border border-white max-h-[80vh] overflow-y-auto">
                <h3 class="text-xl font-bold mb-4 text-slate-800 flex items-center"><i class="fas fa-calculator mr-3 text-[var(--color-primary)]"></i>çµç®—å»ºè­°</h3>
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <div class="text-xs text-slate-400 font-bold mb-1">ç¸½æ”¯å‡º / å¹³å‡æ¯äºº</div>
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-black text-[var(--color-primary)]">Â¥{{ settlementTotal.toLocaleString() }}</span>
                        <span class="text-sm font-bold text-slate-600">Â¥{{ Math.ceil(settlementTotal / (people.length - 1)).toLocaleString() }} <span class="text-[10px] font-normal">/äºº</span></span>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 text-right">*å·²æ’é™¤å…¬æ•¸èˆ‡å…¥é‡‘</div>
                </div>
                <div v-if="settlementPlan.length > 0" class="space-y-3">
                    <div v-for="(plan, idx) in settlementPlan" :key="idx" class="flex items-center justify-between bg-white border border-slate-100 p-3 rounded-xl shadow-sm">
                        <div class="flex items-center"><span class="font-bold text-slate-700">{{ plan.from }}</span><i class="fas fa-long-arrow-alt-right mx-2 text-slate-300"></i><span class="font-bold text-[var(--color-primary)]">{{ plan.to }}</span></div>
                        <span class="font-mono font-bold text-emerald-500">Â¥{{ plan.amount.toLocaleString() }}</span>
                    </div>
                </div>
                <div v-else class="text-center py-8 text-slate-400 text-sm">ç›®å‰æ”¶æ”¯å¹³è¡¡ ğŸ‰</div>
                <button @click="showSettlementModal = false" class="w-full mt-6 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition">é—œé–‰</button>
            </div>
        </div>

        <div v-if="selectedPhrase" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm" @click="selectedPhrase = null">
            <div class="bg-white card-rounded w-full max-w-sm p-8 text-center shadow-2xl relative" @click.stop>
                <div class="text-xs text-[var(--color-primary)] font-bold mb-2 uppercase tracking-widest">{{ selectedPhrase.cat }}</div>
                <div class="text-4xl font-black text-slate-800 mb-4 leading-normal">{{ selectedPhrase.jp }}</div>
                <div class="text-base text-slate-500 mb-6 font-mono">{{ selectedPhrase.pron }}</div>
                <div class="text-lg font-bold text-[var(--color-primary)] bg-[var(--color-bg)] py-3 px-4 rounded-xl inline-block">{{ selectedPhrase.cn }}</div>
                <div class="mt-8 text-xs text-slate-300">é»æ“ŠèƒŒæ™¯é—œé–‰</div>
            </div>
        </div>

    </div>

    <script>
        if (typeof Vue === 'undefined') { alert('Vue.js è¼‰å…¥å¤±æ•—'); }
        if (typeof Papa === 'undefined') { alert('PapaParse è¼‰å…¥å¤±æ•—'); }

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfauoawYSDrE7095JOlcUtV1CIlpdMQVST7EymMSWce9dEzJ4jj7d1-n9hk-gDoin-SbvWAhVk9-Xe/pub?output=csv'; 
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby8nFB7hRWh6_rwttT0dbINC6q8m0nYFUSpTdDIIkp5s0em5kjDFLjKYsna5bbUpnOe/exec'; 
                const people = ['å…¬æ•¸', 'IVAN', 'Hailey', 'ç³å§', 'å‚‘ä¹‚'];

                const hotelList = [
                    { name: 'Vessel Hotel Campana Susukino', nights: 'ç¬¬ 1-2 æ™š', phone: '+81-11-531-8111' },
                    { name: 'æ–°å¯Œè‰¯é‡ç‹å­é£¯åº—', nights: 'ç¬¬ 3 æ™š', phone: '+81-167-22-1111' },
                    { name: 'ç•™å£½éƒ½åº¦å‡é£¯åº—&æœƒè­°ä¸­å¿ƒ', nights: 'ç¬¬ 4-5 æ™š', phone: '+81-136-46-3111' },
                    { name: 'La Vista å‡½é¤¨ç£', nights: 'ç¬¬ 6 æ™š', phone: '+81-138-23-6111' },
                    { name: 'æ´çˆºæ¹– æ¹–ã®æ – (The Lake Suite)', nights: 'ç¬¬ 7 æ™š', phone: '+81-142-82-4121' },
                    { name: 'æœ­å¹Œ Forza (Hotel Forza)', nights: 'ç¬¬ 8 æ™š', phone: '+81-11-222-3555' },
                ];

                const foodRecommendations = {
                    'æ ¹å®¤èŠ±ä¸¸': 'å¿…é»ï¼šäºŒå±¤å¸†ç«‹è²ã€èŠ±å’²èŸ¹éµæ³¢æ±ã€ç‚™ç‡’é®­é­š',
                    'é”æ‘©': 'å¿…é»ï¼šæˆå‰æ€æ±—çƒ¤è‚‰ã€ä¸Šè‚‰ (æ•¸é‡é™å®š)ã€èŒ¶æ³¡é£¯',
                    'æˆå‰æ€æ±—': 'å¿…é»ï¼šæˆå‰æ€æ±—çƒ¤è‚‰ã€å°ç¾Šè‚‰',
                    'ä¸‰è§’å¸‚å ´': 'å¿…é»ï¼šå¸ç‹èŸ¹ã€æµ·è†½ä¸¼ã€æ»æ³¢é£Ÿå ‚/æ­¦ç”°é®®é­šåº—',
                    'Suage': 'å¿…é»ï¼šçŸ¥åºŠé›é‡èœæ¹¯å’–å“©ã€æŸšå­èƒ¡æ¤’é¢¨å‘³',
                    'æ¹¯å’–å“©': 'å¿…é»ï¼šé›è…¿æ¹¯å’–å“©ã€åŠ èµ·å¸é£¯',
                    'ä¸€å¹»': 'å¿…é»ï¼šé®®è¦å‘³å™Œæ‹‰éºµ (é©é‡è±šéª¨/ç²—éºµ)ã€è¦ä»é£¯ç³°',
                    'æ‹‰éºµ': 'å¿…é»ï¼šå‘³å™Œæ‹‰éºµã€å¥¶æ²¹ç‰ç±³æ‹‰éºµ',
                    'LeTAO': 'å¿…é»ï¼šé›™å±¤èŠå£«è›‹ç³• (Double Fromage)ã€ç´…èŒ¶å·§å…‹åŠ›',
                    'åŒ—è“æ¨“': 'å¿…é»ï¼šå¤¢ä¸æ€è­°æ³¡èŠ™ã€å¦–ç²¾ä¹‹æ£®å¹´è¼ªè›‹ç³•',
                    'å…­èŠ±äº­': 'å¿…é»ï¼šèŠå§†è‘¡è„å¥¶æ²¹å¤¾å¿ƒé¤…ã€è‰è“å·§å…‹åŠ›',
                    'å½©æœª': 'å¿…é»ï¼šå‘³å™Œæ‹‰éºµ (ç”Ÿè–‘é¢¨å‘³)',
                    'èŸ¹æœ¬å®¶': 'å¿…é»ï¼šèƒèŸ¹æœƒå¸­æ–™ç†ã€ç‚¸èŸ¹æ®¼',
                    'å†°é›ªä¹‹é–€': 'å¿…é»ï¼šå¸ç‹èŸ¹å…¨é¤'
                };

                const packingItems = [
                    {text: 'è­·ç…§ + å½±æœ¬', checked: false}, {text: 'åœ‹éš›é§•ç…§ + å°ç£é§•ç…§/æ—¥æ–‡è­¯æœ¬', checked: false},
                    {text: 'VJW æˆªåœ– (å…¥å¢ƒ/æµ·é—œ)', checked: false}, {text: 'ç¾é‡‘ (æ—¥å¹£) + ä¿¡ç”¨å¡ (JCBä½³)', checked: false},
                    {text: 'Simå¡ / æ¼«éŠé–‹é€š', checked: false}, {text: 'è¡Œå‹•é›»æº + å……é›»ç·š', checked: false},
                    {text: 'é›ªé´ (é˜²æ»‘é˜²æ°´)', checked: false}, {text: 'ç™¼ç†±è¡£ / ç™¼ç†±è¤²', checked: false},
                    {text: 'æ‰‹å¥— (é˜²æ°´) + æ¯›å¸½', checked: false}, {text: 'å¢¨é¡ (é›ªåœ°åå…‰å¼·)', checked: false},
                    {text: 'å€‹äººå¸¸å‚™è—¥ / æšˆè»Šè—¥', checked: false}, {text: 'ä¿æ¿•ä¹³æ¶² / è­·å”‡è†', checked: false},
                    {text: 'æš–æš–åŒ… (è²¼å¼/æ‰‹æ¡)', checked: false}, {text: 'ç‰™åˆ·ç‰™è† (éƒ¨åˆ†é£¯åº—ä¸ä¸»å‹•æä¾›)', checked: false}
                ];

                const phrasebookData = [
                    {cat: 'é¤å»³', jp: 'è‹±èªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹', pron: 'Eigo no menyu wa arimasuka', cn: 'æœ‰è‹±æ–‡èœå–®å—ï¼Ÿ'},
                    {cat: 'é¤å»³', jp: 'ä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', pron: 'Kaikei o onegaishimasu', cn: 'æˆ‘è¦çµå¸³'},
                    {cat: 'é¤å»³', jp: 'ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹', pron: 'Osusume wa nan desu ka', cn: 'æœ‰ä»€éº¼æ¨è–¦çš„å—ï¼Ÿ'},
                    {cat: 'è‡ªé§•', jp: 'æº€ã‚¿ãƒ³ã€ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼ã§', pron: 'Mantan, Regyura de', cn: 'åŠ æ»¿æ²¹ (Regular)'},
                    {cat: 'è‡ªé§•', jp: 'é§è»Šå ´ã¯ã©ã“ã§ã™ã‹', pron: 'Chushajo wa doko desu ka', cn: 'åœè»Šå ´åœ¨å“ªè£¡ï¼Ÿ'},
                    {cat: 'æ±‚åŠ©', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹', pron: 'Toire wa doko desu ka', cn: 'å»æ‰€åœ¨å“ªè£¡ï¼Ÿ'},
                    {cat: 'æ±‚åŠ©', jp: 'ã™ã¿ã¾ã›ã‚“', pron: 'Sumimasen', cn: 'ä¸å¥½æ„æ€ / è«‹å•'}
                ];

                const activeTab = ref('itinerary');
                const toolSubTab = ref('packing');
                const loading = ref(false);
                const syncingExpenses = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(null);
                const isEditing = ref(false);
                const editingId = ref(null);
                const itineraryData = ref([]);
                const weather = ref(null);
                const usingMockData = ref(false);
                const showExpenseModal = ref(false);
                const showSettlementModal = ref(false);
                const settlementPlan = ref([]);
                const settlementTotal = ref(0);
                const selectedPhrase = ref(null);
                const expenses = ref([]);
                const newExpense = ref({ amount: '', description: '', payer: 'å…¬æ•¸' });
                const expenseMode = ref('expense');
                const selectedDay = ref(null);
                const exchangeRate = ref(null);
                const calcHkd = ref('');
                const calcJpy = ref('');
                const itineraryContainer = ref(null);
                
                const memos = ref(JSON.parse(localStorage.getItem('hokkaido_memos')) || {});
                const packingList = ref(JSON.parse(localStorage.getItem('hokkaido_packing')) || packingItems);
                const shoppingList = ref(JSON.parse(localStorage.getItem('hokkaido_shopping')) || []);
                const newShopItem = ref({text: '', who: ''});
                const carInfo = ref(JSON.parse(localStorage.getItem('hokkaido_car')) || { plate: '', floor: '', zone: '', note: '' });

                const saveCarInfo = () => { localStorage.setItem('hokkaido_car', JSON.stringify(carInfo.value)); };
                
                const isDeposit = (exp) => {
                    return exp.description && exp.description.includes('(å…¥é‡‘)');
                };

                const switchExpenseMode = (mode) => {
                    expenseMode.value = mode;
                    if (mode === 'deposit') {
                        newExpense.value.payer = 'IVAN'; 
                        newExpense.value.description = 'å…¬è²»å…¥é‡‘';
                    } else {
                        newExpense.value.payer = 'å…¬æ•¸';
                        newExpense.value.description = '';
                    }
                };

                const publicFundBalance = computed(() => {
                    let balance = 0;
                    expenses.value.forEach(exp => {
                        const amount = parseInt(exp.amount) || 0;
                        if (exp.payer === 'å…¬æ•¸') {
                            balance -= amount;
                        }
                        if (isDeposit(exp)) {
                            balance += amount;
                        }
                    });
                    return balance;
                });

                const calculateSettlement = () => {
                    const balance = {};
                    people.forEach(p => { if(p !== 'å…¬æ•¸') balance[p] = 0; });
                    
                    let total = 0;
                    expenses.value.forEach(exp => {
                        if (exp.payer !== 'å…¬æ•¸' && !isDeposit(exp)) {
                            const amount = parseInt(exp.amount);
                            balance[exp.payer] += amount;
                            total += amount;
                        }
                    });

                    settlementTotal.value = total;
                    const personCount = people.length - 1;
                    const average = total / personCount;

                    const diffs = [];
                    for (const person in balance) {
                        diffs.push({ name: person, val: balance[person] - average });
                    }

                    diffs.sort((a, b) => a.val - b.val);
                    const plan = [];
                    
                    let i = 0; 
                    let j = diffs.length - 1; 

                    while (i < j) {
                        const debtor = diffs[i];
                        const creditor = diffs[j];
                        if (Math.abs(debtor.val) < 1 && Math.abs(creditor.val) < 1) break; 
                        const amount = Math.min(Math.abs(debtor.val), creditor.val);
                        if (amount > 0) {
                            plan.push({ from: debtor.name, to: creditor.name, amount: Math.ceil(amount) });
                        }
                        debtor.val += amount;
                        creditor.val -= amount;
                        if (Math.abs(debtor.val) < 1) i++;
                        if (Math.abs(creditor.val) < 1) j--;
                    }
                    settlementPlan.value = plan;
                    showSettlementModal.value = true;
                };

                const fetchItinerary = () => {
                    loading.value = true;
                    if (!SHEET_CSV_URL) { useMockData(); return; }
                    Papa.parse(SHEET_CSV_URL, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (results) => {
                            const validData = results.data.filter(row => row.Date && row.Activity);
                            if(validData.length > 0) { 
                                itineraryData.value = validData; 
                                usingMockData.value = false;
                                const firstDay = validData[0]?.Date.trim();
                                if(firstDay) selectedDay.value = firstDay;
                            }
                            loading.value = false;
                        },
                        error: (err) => { console.error(err); loading.value = false; }
                    });
                };

                const useMockData = () => {
                    itineraryData.value = [{ Date: '2025/12/20', Time: '', Location: 'æ–°åƒæ­²æ©Ÿå ´', Activity: 'æŠµé”ï¼', Note: 'ç¯„ä¾‹è³‡æ–™', Category: 'Transport', Link: '' }];
                    usingMockData.value = true;
                    loading.value = false;
                    selectedDay.value = '2025/12/20';
                };

                const fetchExpenses = async () => {
                    if (!APPS_SCRIPT_URL) return;
                    syncingExpenses.value = true;
                    try {
                        const res = await fetch(APPS_SCRIPT_URL);
                        const data = await res.json();
                        if (Array.isArray(data)) { expenses.value = data; }
                    } catch (e) { console.error("Sync error", e); } finally { syncingExpenses.value = false; }
                };

                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0618&longitude=141.3545&current_weather=true&daily=sunset&timezone=Asia%2FTokyo');
                        const data = await res.json();
                        weather.value = data;
                    } catch (e) { console.error(e); }
                };
                
                const fetchRate = async () => {
                    try {
                        const res = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                        const data = await res.json();
                        exchangeRate.value = data.rates.JPY;
                    } catch (e) { console.error(e); }
                };
                
                const updateFromHkd = () => {
                    if(!exchangeRate.value || !calcHkd.value) { calcJpy.value = ''; return; }
                    calcJpy.value = (parseFloat(calcHkd.value) * exchangeRate.value).toFixed(0);
                };
                const updateFromJpy = () => {
                    if(!exchangeRate.value || !calcJpy.value) { calcHkd.value = ''; return; }
                    calcHkd.value = (parseFloat(calcJpy.value) / exchangeRate.value).toFixed(1);
                };

                const openEditModal = (item = null) => {
                    if (item) {
                        isEditing.value = true;
                        editingId.value = item.id;
                        newExpense.value = {
                            amount: parseInt(item.amount),
                            description: item.description,
                            payer: item.payer
                        };
                        expenseMode.value = isDeposit(item) ? 'deposit' : 'expense';
                    } else {
                        isEditing.value = false;
                        editingId.value = null;
                        newExpense.value = { amount: '', description: '', payer: 'å…¬æ•¸' };
                        expenseMode.value = 'expense';
                    }
                    showExpenseModal.value = true;
                };

                const submitExpense = async () => {
                    if (!newExpense.value.amount) return;
                    if (!APPS_SCRIPT_URL) { alert("è«‹å…ˆè¨­å®š Apps Script ç¶²å€ï¼"); return; }
                    isSaving.value = true;

                    let finalDesc = newExpense.value.description;
                    if (expenseMode.value === 'deposit') {
                        finalDesc = finalDesc.includes('(å…¥é‡‘)') ? finalDesc : `(å…¥é‡‘) ${finalDesc}`;
                    }

                    const expenseData = { 
                        amount: parseInt(newExpense.value.amount), 
                        description: finalDesc, 
                        payer: newExpense.value.payer 
                    };

                    try {
                        if (isEditing.value && editingId.value) {
                            // Edit: Delete old then Add new
                            await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'delete', id: editingId.value }) });
                            expenses.value = expenses.value.filter(e => e.id !== editingId.value);
                        }

                        // Add new
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(expenseData) });
                        expenses.value.unshift({ ...expenseData, date: new Date().toISOString(), id: 'temp-' + Date.now() });
                        
                        showExpenseModal.value = false;
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("å„²å­˜å¤±æ•—"); } finally { isSaving.value = false; }
                };

                const addExpense = submitExpense; // Alias for template compatibility

                const deleteExpense = async (item) => {
                    if (!item.id) { alert("ç„¡æ³•åˆªé™¤èˆŠè³‡æ–™"); return; }
                    if (!confirm(`åˆªé™¤ã€Œ${item.description}ã€ï¼Ÿ`)) return;
                    isDeleting.value = item.id;
                    try {
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'delete', id: item.id }) });
                        expenses.value = expenses.value.filter(e => e.id !== item.id);
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("åˆªé™¤å¤±æ•—"); } finally { isDeleting.value = null; }
                };
                
                const togglePacking = (idx) => {
                    packingList.value[idx].checked = !packingList.value[idx].checked;
                    localStorage.setItem('hokkaido_packing', JSON.stringify(packingList.value));
                };
                
                const addShopItem = () => {
                    if(!newShopItem.value.text) return;
                    shoppingList.value.push({ text: newShopItem.value.text, who: newShopItem.value.who || 'è‡ªå·±', checked: false });
                    localStorage.setItem('hokkaido_shopping', JSON.stringify(shoppingList.value));
                    newShopItem.value = { text: '', who: '' };
                };
                
                const toggleShop = (idx) => {
                    shoppingList.value[idx].checked = !shoppingList.value[idx].checked;
                    localStorage.setItem('hokkaido_shopping', JSON.stringify(shoppingList.value));
                };
                
                const removeShopItem = (idx) => {
                    if(confirm('åˆªé™¤æ­¤ä»£è³¼é …ç›®ï¼Ÿ')) {
                        shoppingList.value.splice(idx, 1);
                        localStorage.setItem('hokkaido_shopping', JSON.stringify(shoppingList.value));
                    }
                };
                
                const showPhraseModal = (phrase) => { selectedPhrase.value = phrase; };
                
                const getItemKey = (item) => {
                    return `${item.Date}-${item.Time}-${item.Activity}`;
                };
                const saveMemos = () => {
                    localStorage.setItem('hokkaido_memos', JSON.stringify(memos.value));
                };

                const refreshAll = () => { fetchItinerary(); fetchExpenses(); fetchWeather(); fetchRate(); };

                const bannerImage = computed(() => {
                    if (dateKeys.value.length === 0 || !selectedDay.value) return '1.jpg';
                    const index = dateKeys.value.indexOf(selectedDay.value);
                    return `${index + 1}.jpg`;
                });
                
                const countdown = computed(() => {
                    const today = new Date();
                    // â˜…â˜…â˜… ä¿®æ­£æ—¥æœŸç‚º 2026-03-07 â˜…â˜…â˜…
                    const tripStart = new Date('2026-03-07');
                    const diffTime = tripStart - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return diffDays > 0 ? diffDays : 0;
                });

                const sunsetTime = computed(() => {
                    if (!weather.value || !weather.value.daily || !weather.value.daily.sunset) return '';
                    return weather.value.daily.sunset[0].split('T')[1];
                });

                const groupedItinerary = computed(() => {
                    const groups = {};
                    itineraryData.value.forEach(item => {
                        const dateKey = item.Date.trim();
                        if (!groups[dateKey]) groups[dateKey] = [];
                        groups[dateKey].push(item);
                    });
                    return Object.keys(groups).sort().reduce((acc, date) => { acc[date] = groups[date]; return acc; }, {});
                });
                
                const dateKeys = computed(() => Object.keys(groupedItinerary.value));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (parseInt(item.amount)||0), 0));
                const getPersonTotal = (name) => { return expenses.value.filter(e => e.payer === name).reduce((sum, e) => sum + (parseInt(e.amount)||0), 0); };

                const getCategoryBorderClass = (cat) => {
                    if (!cat) return 'border-l-slate-300';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('é£Ÿ')) return 'border-l-orange-400';
                    if (c.includes('transport') || c.includes('è¡Œ') || c.includes('è»Š')) return 'border-l-blue-400';
                    if (c.includes('sight') || c.includes('æ™¯')) return 'border-l-emerald-400';
                    if (c.includes('shop') || c.includes('è²·')) return 'border-l-pink-400';
                    return 'border-l-[var(--color-primary)]';
                };

                const getCategoryIconClass = (cat) => {
                    if (!cat) return 'border-slate-200 text-slate-300 bg-slate-50';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('é£Ÿ')) return 'border-orange-200 text-orange-400 bg-orange-50';
                    if (c.includes('transport') || c.includes('è¡Œ') || c.includes('è»Š')) return 'border-blue-200 text-blue-400 bg-blue-50';
                    if (c.includes('sight') || c.includes('æ™¯')) return 'border-emerald-200 text-emerald-500 bg-emerald-50';
                    if (c.includes('shop') || c.includes('è²·')) return 'border-pink-200 text-pink-400 bg-pink-50';
                    return 'border-[var(--color-primary)] text-[var(--color-primary)] bg-sky-50';
                };

                const getCategoryIcon = (cat) => {
                    if (!cat) return 'fas fa-circle';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('é£Ÿ')) return 'fas fa-utensils';
                    if (c.includes('transport') || c.includes('è¡Œ') || c.includes('è»Š')) return 'fas fa-train';
                    if (c.includes('sight') || c.includes('æ™¯')) return 'fas fa-camera';
                    if (c.includes('shop') || c.includes('è²·')) return 'fas fa-shopping-bag';
                    return 'fas fa-map-pin';
                };

                const getFoodRecommendation = (item) => {
                    const cat = (item.Category || '').toLowerCase();
                    if (!cat.includes('food') && !cat.includes('é£Ÿ')) return null;
                    const activity = (item.Activity || '').toLowerCase();
                    const location = (item.Location || '').toLowerCase();
                    const combinedText = activity + location;
                    if (combinedText.includes('æ—©é¤') || combinedText.includes('breakfast')) {
                        if (!combinedText.includes('äºŒæ¢') && !combinedText.includes('ä¸‰è§’')) return null;
                    }
                    for (const [key, recommend] of Object.entries(foodRecommendations)) {
                        if (combinedText.includes(key.toLowerCase())) {
                            return recommend;
                        }
                    }
                    return null;
                };

                const formatDate = (dateStr) => { try { const d = new Date(dateStr); return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`; } catch (e) { return dateStr; } };
                const formatShortDate = (dateStr) => { if(!dateStr) return ''; try { const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()}`; } catch (e) { return ''; } }
                const getDayOfWeek = (dateStr) => { try { return ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][new Date(dateStr).getDay()]; } catch (e) { return ''; } };

                watch(selectedDay, () => {
                    if (itineraryContainer.value) {
                        itineraryContainer.value.scrollTop = 0;
                    }
                });

                onMounted(() => { refreshAll(); });

                return {
                    people, activeTab, toolSubTab, loading, weather, sunsetTime, groupedItinerary, dateKeys, selectedDay, expenses,
                    totalExpense, showExpenseModal, newExpense, addExpense, deleteExpense, refreshAll, syncingExpenses, isSaving, isDeleting,
                    formatDate, formatShortDate, getDayOfWeek, getCategoryBorderClass, getCategoryIconClass, getCategoryIcon, getFoodRecommendation,
                    SHEET_CSV_URL, APPS_SCRIPT_URL, getPersonTotal, usingMockData, bannerImage, countdown,
                    exchangeRate, calcHkd, calcJpy, updateFromHkd, updateFromJpy, hotelList, itineraryContainer,
                    packingList, shoppingList, newShopItem, togglePacking, addShopItem, toggleShop, removeShopItem, phrasebook: phrasebookData, selectedPhrase, showPhraseModal,
                    memos, saveMemos, getItemKey, carInfo, saveCarInfo, showSettlementModal, settlementPlan, calculateSettlement, settlementTotal,
                    expenseMode, switchExpenseMode, isDeposit, publicFundBalance,
                    openEditModal, submitExpense, isEditing
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


