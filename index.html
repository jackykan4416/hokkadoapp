<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂåóÊµ∑ÈÅìÂÜ¨‰πãÊóÖ</title>
    
    <!-- ‰ΩøÁî® jsDelivr ËºâÂÖ• Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts: Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primary: #4A7C9D;
            --color-primary-dark: #375D75;
            --color-bg: #F0F8FF;
            --color-text: #2C3E50;
        }

        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: var(--color-bg);
            background-image: radial-gradient(#CBD5E0 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--color-text);
            -webkit-tap-highlight-color: transparent; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        [v-cloak] { display: none !important; }
        
        .floating-nav {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            width: 85%;
            max-width: 380px;
            border-radius: 999px;
            background: rgba(44, 62, 80, 0.9);
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 50;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .card-rounded { border-radius: 20px; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <div id="app" class="h-full flex flex-col relative" v-cloak>
        
        <!-- Header: ÊîπÁÇ∫ Banner Ê®£ÂºèÔºåÈ´òÂ∫¶ 250px -->
        <header class="relative w-full h-[250px] shadow-md z-20 flex-shrink-0">
            <!-- ËÉåÊôØÂúñÁâáÔºö‰ΩøÁî® Google Drive Áõ¥ÈÄ£ÈÄ£Áµê -->
            <img src="https://drive.google.com/uc?export=view&id=1mYxmrNBZTwFZeGG1I_c4vKBgVEUNhzKD" alt="Header Banner" class="absolute inset-0 w-full h-full object-cover object-center z-0">
            
            <!-- ÁôΩËâ≤ÈÅÆÁΩ©Ôºö45% ÈÄèÊòéÂ∫¶ -->
            <div class="absolute inset-0 bg-white/45 backdrop-blur-[2px] z-10"></div>

            <!-- ÂÖßÂÆπÂÆπÂô®ÔºöÊµÆÂú®ÈÅÆÁΩ©‰πã‰∏ä -->
            <div class="relative z-20 px-6 py-6 flex justify-between items-start h-full">
                <div>
                    <h1 class="text-3xl font-black tracking-wider flex items-center mb-2 text-[var(--color-primary)] drop-shadow-sm">
                        <i class="fas fa-snowflake text-sky-500 mr-3 animate-pulse"></i>
                        Hokkaido
                    </h1>
                    
                    <div class="flex flex-col space-y-1">
                        <div class="flex items-center space-x-3 text-sm text-slate-800 font-bold" v-if="weather">
                            <span class="flex items-center bg-white/60 px-2 py-1 rounded-lg">
                                <i class="fas fa-temperature-low mr-1.5 text-[var(--color-primary)]"></i>{{ weather.current_weather.temperature }}¬∞C
                            </span>
                            <span class="flex items-center text-orange-600 bg-white/60 px-2 py-1 rounded-lg">
                                <i class="fas fa-cloud-sun mr-1.5"></i>Êó•ËêΩ {{ sunsetTime }}
                            </span>
                        </div>
                        <p class="text-xs text-slate-600 font-bold mt-1" v-else>
                            <i class="fas fa-circle-notch fa-spin mr-1"></i>ËÆÄÂèñÂ§©Ê∞£‰∏≠...
                        </p>
                        
                        <div v-if="weather" class="mt-2">
                            <a href="https://weathernews.jp/onebox/43.06417/141.34694/temp=c" target="_blank" class="text-[10px] text-slate-600 hover:text-[var(--color-primary)] transition flex items-center bg-white/50 px-2 py-1 rounded-full w-max border border-white/50 font-bold">
                                Weathernews <i class="fas fa-external-link-alt ml-1.5"></i>
                            </a>
                        </div>
                    </div>
                </div>
                
                <button @click="refreshAll" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/60 text-slate-600 hover:bg-white transition active:scale-90 shadow-sm backdrop-blur-sm">
                    <i class="fas fa-sync-alt" :class="{'animate-spin': loading}"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto no-scrollbar pb-32 px-4 pt-6">
            
            <!-- Tab 1: Ë°åÁ®ã -->
            <transition name="fade" mode="out-in">
                <div v-if="activeTab === 'itinerary'" key="itinerary" class="flex flex-col h-full">
                    
                    <!-- Êó•ÊúüÈÅ∏ÊìáÂô® -->
                    <div v-if="dateKeys.length > 0" class="flex space-x-2 overflow-x-auto no-scrollbar pb-4 px-1 flex-shrink-0">
                        <button 
                            v-for="date in dateKeys" 
                            :key="date"
                            @click="selectedDay = date"
                            class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all border"
                            :class="selectedDay === date ? 'bg-[var(--color-primary)] text-white border-transparent shadow-md' : 'bg-white text-slate-400 border-slate-200 hover:bg-slate-50'"
                        >
                            {{ formatShortDate(date) }}
                        </button>
                    </div>

                    <!-- Ë°åÁ®ãÂàóË°® -->
                    <div class="flex-1 overflow-y-auto no-scrollbar pb-24">
                        <div v-if="selectedDay && groupedItinerary[selectedDay]" class="space-y-0">
                            
                            <!-- Êó•ÊúüÂ§ßÊ®ôÈ°å -->
                            <div class="flex items-center mb-6 mt-2 ml-2">
                                <div class="bg-[var(--color-primary)] text-white w-12 h-12 flex items-center justify-center rounded-xl font-black text-xl shadow-lg shadow-blue-900/10 mr-4">
                                    {{ new Date(selectedDay).getDate() }}
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-slate-700">{{ formatDate(selectedDay) }}</h2>
                                    <span class="text-slate-400 text-xs font-bold bg-slate-100 px-2 py-0.5 rounded">{{ getDayOfWeek(selectedDay) }}</span>
                                </div>
                            </div>

                            <div v-for="(item, index) in groupedItinerary[selectedDay]" :key="index" class="relative pl-2 pb-2">
                                
                                <!-- ÁßªÂãïÊñπÂºè -->
                                <div v-if="index > 0 && (item.Transport || item.Duration)" class="flex items-center justify-center mb-8 ml-8 relative z-0">
                                    <div class="bg-slate-100 text-slate-600 px-6 py-3 rounded-full text-base font-bold flex items-center border-2 border-slate-200 z-10 shadow-sm">
                                        <span class="mr-3 text-2xl" v-if="item.Transport && item.Transport.includes('Ëªä')">üöó</span>
                                        <span class="mr-3 text-2xl" v-else-if="item.Transport && (item.Transport.includes('Ëµ∞') || item.Transport.includes('Ê≠•'))">üö∂</span>
                                        <span class="mr-3 text-2xl" v-else-if="item.Transport && (item.Transport.includes('JR') || item.Transport.includes('Èêµ'))">üöÉ</span>
                                        <span v-if="item.Transport" class="mr-1">{{ item.Transport }}</span>
                                        <span v-if="item.Duration" class="text-slate-400 border-l-2 border-slate-300 pl-3 ml-2">{{ item.Duration }}</span>
                                    </div>
                                    <div class="absolute top-[-30px] bottom-[-30px] left-1/2 w-1 bg-slate-200 -z-10 h-[calc(100%+60px)]"></div>
                                </div>

                                <!-- Âç°ÁâáÊú¨È´î -->
                                <div 
                                    class="bg-white card-rounded shadow-sm p-5 relative overflow-hidden transition-all mb-6 border-l-[6px]"
                                    :class="getCategoryBorderClass(item.Category)"
                                >
                                    <div class="flex items-start pl-1">
                                        <div class="flex flex-col items-center mr-5 pt-1 min-w-[45px]">
                                            <span class="text-base font-black text-slate-700 font-mono tracking-tight">{{ item.Time || '--:--' }}</span>
                                            <div 
                                                class="mt-3 w-8 h-8 rounded-full flex items-center justify-center border"
                                                :class="getCategoryIconClass(item.Category)"
                                            >
                                                <i :class="getCategoryIcon(item.Category)"></i>
                                            </div>
                                        </div>

                                        <div class="flex-1 border-l-2 border-slate-50 pl-5">
                                            <h3 class="font-bold text-slate-800 text-lg leading-snug mb-2">{{ item.Activity }}</h3>
                                            
                                            <div class="flex items-center text-xs text-slate-500 mb-3 font-bold">
                                                <i class="fas fa-map-marker-alt text-red-400 mr-1.5"></i>
                                                <span>{{ item.Location || 'Êú™ÊåáÂÆöÂú∞Èªû' }}</span>
                                            </div>

                                            <div v-if="item.MapCode" class="mb-3">
                                                <div class="bg-[var(--color-bg)] px-3 py-2 rounded-xl flex items-center border border-slate-100">
                                                    <i class="fas fa-car-side text-[var(--color-primary)] mr-3 text-lg opacity-80"></i>
                                                    <div class="flex flex-col">
                                                        <span class="text-[9px] text-slate-400 uppercase tracking-wider font-bold">NAVI / MAPCODE</span>
                                                        <span class="font-mono text-base font-bold text-slate-700 tracking-wide">{{ item.MapCode }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div v-if="getFoodRecommendation(item)" class="bg-yellow-50 rounded-xl p-3 mb-3 border border-yellow-100">
                                                <div class="flex items-start">
                                                    <span class="text-xl mr-2">üí°</span>
                                                    <div>
                                                        <span class="text-[10px] text-yellow-600 font-black uppercase tracking-wider block mb-0.5">È•ïÂÆ¢Êé®Ëñ¶</span>
                                                        <span class="text-sm text-slate-700 font-bold leading-relaxed">{{ getFoodRecommendation(item) }}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <div v-if="item.Note" class="bg-slate-50 rounded-xl p-3 mb-3 text-sm text-slate-600 flex items-start border border-slate-100">
                                                <span class="text-slate-400 mr-2 mt-0.5">‚óè</span>
                                                <span class="leading-relaxed text-xs">{{ item.Note }}</span>
                                            </div>

                                            <div v-if="item.Link" class="mt-2 flex justify-end">
                                                <a :href="item.Link" target="_blank" class="inline-flex justify-center items-center text-xs font-bold text-[var(--color-primary)] border border-[var(--color-primary)] px-4 py-1.5 rounded-full hover:bg-[var(--color-primary)] hover:text-white transition">
                                                    <i class="fas fa-location-arrow mr-2"></i> Â∞éËà™
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div v-if="dateKeys.length === 0 && !loading" class="text-center py-20 text-slate-300">
                            <i class="far fa-snowflake text-5xl mb-4 opacity-50"></i><p>Ê≤íÊúâË°åÁ®ãË≥áÊñô</p>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: ÂàÜÂ∏≥ -->
                <div v-else-if="activeTab === 'expenses'" key="expenses">
                    <div class="bg-gradient-to-br from-slate-700 to-slate-800 p-6 card-rounded shadow-xl mb-6 text-center text-white relative overflow-hidden mx-1 mt-2">
                        <p class="text-slate-300 text-xs mb-1 font-bold tracking-widest uppercase">Total Expenses</p>
                        <h2 class="text-5xl font-black mb-6 tracking-tight font-mono">¬•{{ totalExpense.toLocaleString() }}</h2>
                        <div class="grid grid-cols-5 gap-2 text-[10px] text-white pt-4 border-t border-slate-600">
                            <div v-for="name in people" :key="name" class="flex flex-col items-center">
                                <span class="font-bold mb-1 opacity-70">{{ name }}</span>
                                <span class="bg-white/10 px-1 py-1 rounded-lg w-full text-center">¬•{{ getPersonTotal(name).toLocaleString() }}</span>
                            </div>
                        </div>
                    </div>

                    <div v-if="!APPS_SCRIPT_URL" class="bg-red-50 text-red-500 p-4 rounded-2xl text-xs mb-4 flex items-center border border-red-100 mx-1"><i class="fas fa-exclamation-triangle mr-3 text-lg"></i> Ë´ãÂ°´ÂÖ• Apps Script Á∂≤ÂùÄ</div>

                    <button @click="showExpenseModal = true" class="w-full bg-[var(--color-primary)] hover:bg-[var(--color-primary-dark)] text-white font-bold py-4 rounded-2xl shadow-lg shadow-blue-900/20 transition transform active:scale-95 mb-6 flex items-center justify-center mx-auto text-lg"><i class="fas fa-plus mr-2"></i> Ë®ò‰∏ÄÁ≠Ü</button>

                    <div class="space-y-4 pb-24 px-1">
                        <div v-for="(exp, index) in expenses" :key="index" class="bg-white p-5 card-rounded shadow-sm flex justify-between items-center border border-slate-50">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center mr-4 font-black text-sm shrink-0">{{ exp.payer.charAt(0) }}</div>
                                <div><h4 class="font-bold text-slate-800 text-base line-clamp-1">{{ exp.description }}</h4><p class="text-xs text-slate-400 font-bold mt-0.5">{{ exp.payer }} ÂÖà‰ªò</p></div>
                            </div>
                            <div class="text-right shrink-0 ml-3 min-w-[80px]">
                                <span class="block font-black text-[var(--color-primary)] text-lg">¬•{{ parseInt(exp.amount).toLocaleString() }}</span>
                                <span class="text-[10px] text-slate-300 block mt-0.5 mb-1">{{ formatShortDate(exp.date) }}</span>
                                <button v-if="exp.id" @click="deleteExpense(exp)" :disabled="isDeleting === exp.id" class="text-[10px] text-red-400 hover:text-red-600 px-2 py-1 bg-red-50 rounded-lg transition font-bold">
                                    <span v-if="isDeleting === exp.id"><i class="fas fa-spinner fa-spin"></i></span><span v-else>Âà™Èô§</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Ë≥áË®ä -->
                <div v-else-if="activeTab === 'info'" key="info">
                    <div class="bg-white card-rounded shadow-sm p-6 mb-6 border border-slate-50 mt-2 mx-1 relative overflow-hidden">
                        <h3 class="font-bold text-[var(--color-primary)] mb-4 flex items-center text-lg"><i class="fas fa-coins text-yellow-400 mr-3 text-xl"></i> ÂØ¶ÊôÇÂåØÁéá</h3>
                        <div class="flex items-center space-x-3 mb-3 relative z-10">
                            <div class="flex-1 bg-[var(--color-bg)] rounded-2xl p-4">
                                <label class="block text-[10px] text-slate-400 mb-1 font-black tracking-widest">HKD</label>
                                <input type="number" v-model="calcHkd" @input="updateFromHkd" class="w-full bg-transparent border-none p-0 text-2xl font-black text-slate-700 focus:ring-0 placeholder-slate-300 font-mono" placeholder="0">
                            </div>
                            <i class="fas fa-exchange-alt text-slate-300 text-xl"></i>
                            <div class="flex-1 bg-[var(--color-bg)] rounded-2xl p-4">
                                <label class="block text-[10px] text-slate-400 mb-1 font-black tracking-widest">JPY</label>
                                <input type="number" v-model="calcJpy" @input="updateFromJpy" class="w-full bg-transparent border-none p-0 text-2xl font-black text-slate-700 focus:ring-0 placeholder-slate-300 font-mono" placeholder="0">
                            </div>
                        </div>
                        <div class="text-right text-xs text-slate-400 font-bold px-1"><span v-if="exchangeRate">1 HKD ‚âà {{ exchangeRate.toFixed(2) }} JPY</span><span v-else><i class="fas fa-spinner fa-spin"></i> ËºâÂÖ•‰∏≠...</span></div>
                    </div>

                    <div class="bg-white card-rounded shadow-sm mb-6 overflow-hidden border border-slate-50 mx-1">
                        <div class="bg-[var(--color-primary)] px-6 py-4 flex justify-between items-center">
                            <h3 class="text-white font-bold text-base tracking-wide"><i class="fas fa-plane-departure mr-3"></i>Ëà™Áè≠Ë≥áË®ä</h3>
                            <span class="text-white/80 text-[10px] bg-white/20 px-3 py-1 rounded-full font-bold">HK Airlines</span>
                        </div>
                        <div class="p-6 space-y-8">
                            <div class="flex items-center justify-between relative">
                                <div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">HKG</div><div class="text-xs text-white font-bold bg-slate-400 rounded-lg px-2 py-1 mt-1 inline-block">08:35</div></div>
                                <div class="text-center w-1/3 flex flex-col items-center px-2"><div class="text-[10px] text-slate-400 font-bold mb-1">HX690</div><div class="w-full flex items-center"><div class="h-[2px] bg-slate-200 w-full rounded-full"></div><i class="fas fa-plane text-slate-300 mx-2 text-sm"></i><div class="h-[2px] bg-slate-200 w-full rounded-full"></div></div><div class="text-[10px] text-slate-400 mt-1 font-bold">5h 45m</div></div>
                                <div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">CTS</div><div class="text-xs text-white font-bold bg-[var(--color-primary)] rounded-lg px-2 py-1 mt-1 inline-block">14:20</div></div>
                            </div>
                            <div class="flex items-center justify-between relative">
                                <div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">CTS</div><div class="text-xs text-white font-bold bg-[var(--color-primary)] rounded-lg px-2 py-1 mt-1 inline-block">16:15</div></div>
                                <div class="text-center w-1/3 flex flex-col items-center px-2"><div class="text-[10px] text-slate-400 font-bold mb-1">HX693</div><div class="w-full flex items-center"><div class="h-[2px] bg-slate-200 w-full rounded-full"></div><i class="fas fa-plane text-slate-300 mx-2 text-sm transform rotate-180"></i><div class="h-[2px] bg-slate-200 w-full rounded-full"></div></div><div class="text-[10px] text-slate-400 mt-1 font-bold">6h 45m</div></div>
                                <div class="text-center w-1/3"><div class="text-3xl font-black text-slate-700">HKG</div><div class="text-xs text-white font-bold bg-slate-400 rounded-lg px-2 py-1 mt-1 inline-block">22:00</div></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white card-rounded shadow-sm mb-6 border border-slate-50 mx-1">
                        <div class="px-6 py-5 border-b border-slate-50 flex items-center"><div class="bg-indigo-50 p-2 rounded-lg mr-3"><i class="fas fa-bed text-indigo-500"></i></div><h3 class="font-bold text-slate-800 text-lg">‰ΩèÂÆøÊ∏ÖÂñÆ</h3></div>
                        <div class="divide-y divide-slate-50">
                            <div v-for="(hotel, index) in hotelList" :key="index" class="p-5 hover:bg-slate-50 transition">
                                <div class="flex justify-between items-start mb-2"><span class="bg-indigo-50 text-indigo-600 text-[10px] px-3 py-1 rounded-full font-black tracking-wide">{{ hotel.nights }}</span></div>
                                <h4 class="font-bold text-slate-700 text-base mb-4 leading-tight">{{ hotel.name }}</h4>
                                <a :href="'tel:' + hotel.phone" class="flex items-center justify-center w-full text-sm text-slate-500 bg-[var(--color-bg)] px-4 py-3 rounded-xl hover:bg-indigo-50 hover:text-indigo-600 transition font-bold border border-transparent hover:border-indigo-100"><i class="fas fa-phone-alt mr-3"></i> {{ hotel.phone }}</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-28 opacity-30"><i class="fas fa-snowman text-5xl mb-3 text-[var(--color-primary)]"></i><p class="text-xs font-bold tracking-widest text-[var(--color-primary)]">Have a nice trip!</p></div>
                </div>
            </transition>
        </main>

        <nav class="floating-nav flex justify-between items-center py-2 px-6">
            <button @click="activeTab = 'itinerary'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'itinerary' ? 'text-white' : 'text-slate-500'"><i class="fas fa-calendar-alt text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">Ë°åÁ®ã</span></button>
            <button @click="activeTab = 'expenses'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'expenses' ? 'text-emerald-400' : 'text-slate-500'"><i class="fas fa-wallet text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">ÂàÜÂ∏≥</span></button>
            <button @click="activeTab = 'info'" class="flex-1 py-3 flex flex-col items-center transition duration-300 relative group" :class="activeTab === 'info' ? 'text-indigo-400' : 'text-slate-500'"><i class="fas fa-book-open text-xl mb-1 transition-transform group-active:scale-90"></i><span class="text-[10px] font-bold">Ë≥áË®ä</span></button>
        </nav>

        <div v-if="showExpenseModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm" @click.self="showExpenseModal = false">
            <div class="bg-white card-rounded w-full max-w-sm p-8 shadow-2xl transform transition-all border border-white">
                <h3 class="text-xl font-bold mb-8 text-slate-800 flex items-center"><i class="fas fa-edit mr-3 text-[var(--color-primary)]"></i>Êñ∞Â¢ûÊîØÂá∫</h3>
                <div class="space-y-6">
                    <div><label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">ÈáëÈ°ç (JPY)</label><input type="number" v-model="newExpense.amount" class="w-full bg-[var(--color-bg)] border-none rounded-2xl p-4 text-xl text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition font-mono" placeholder="1000" inputmode="numeric"></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">È†ÖÁõÆË™™Êòé</label><input type="text" v-model="newExpense.description" class="w-full bg-[var(--color-bg)] border-none rounded-2xl p-4 text-base text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] transition" placeholder="‰æãÂ¶Ç: ÊãâÈ∫µ"></div>
                    <div><label class="block text-xs font-black text-slate-400 mb-2 ml-1 tracking-wider uppercase">Ë™∞ÂÖà‰ªòÁöÑÔºü</label><div class="relative"><select v-model="newExpense.payer" class="w-full bg-[var(--color-bg)] border-none rounded-2xl p-4 text-base text-slate-800 font-bold focus:ring-2 focus:ring-[var(--color-primary)] appearance-none"><option v-for="person in people" :key="person" :value="person">{{ person }}</option></select><i class="fas fa-chevron-down absolute right-5 top-5 text-slate-400 pointer-events-none"></i></div></div>
                </div>
                <div class="mt-10 flex space-x-4">
                    <button @click="showExpenseModal = false" class="flex-1 py-4 bg-slate-100 text-slate-500 rounded-2xl font-bold hover:bg-slate-200 transition">ÂèñÊ∂à</button>
                    <button @click="addExpense" :disabled="isSaving" class="flex-1 py-4 bg-[var(--color-primary)] text-white rounded-2xl font-bold hover:opacity-90 transition shadow-lg shadow-blue-900/20 flex justify-center items-center"><span v-if="isSaving"><i class="fas fa-circle-notch fa-spin mr-2"></i>ÂÑ≤Â≠ò‰∏≠</span><span v-else>ÂÑ≤Â≠ò</span></button>
                </div>
            </div>
        </div>

    </div>

    <script>
        if (typeof Vue === 'undefined') { alert('Vue.js ËºâÂÖ•Â§±Êïó'); }
        if (typeof Papa === 'undefined') { alert('PapaParse ËºâÂÖ•Â§±Êïó'); }

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfauoawYSDrE7095JOlcUtV1CIlpdMQVST7EymMSWce9dEzJ4jj7d1-n9hk-gDoin-SbvWAhVk9-Xe/pub?output=csv'; 
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby8nFB7hRWh6_rwttT0dbINC6q8m0nYFUSpTdDIIkp5s0em5kjDFLjKYsna5bbUpnOe/exec'; 
                const people = ['IVAN', 'Hailey', 'Áê≥Âßê', 'ÂÇë‰πÇ', 'ÂÖ¨Êï∏'];

                const hotelList = [
                    { name: 'Vessel Hotel Campana Susukino', nights: 'Á¨¨ 1-2 Êôö', phone: '+81-11-531-8111' },
                    { name: 'Êñ∞ÂØåËâØÈáéÁéãÂ≠êÈ£ØÂ∫ó', nights: 'Á¨¨ 3 Êôö', phone: '+81-167-22-1111' },
                    { name: 'ÁïôÂ£ΩÈÉΩÂ∫¶ÂÅáÈ£ØÂ∫ó&ÊúÉË≠∞‰∏≠ÂøÉ', nights: 'Á¨¨ 4-5 Êôö', phone: '+81-136-46-3111' },
                    { name: 'La Vista ÂáΩÈ§®ÁÅ£', nights: 'Á¨¨ 6 Êôö', phone: '+81-138-23-6111' },
                    { name: 'Ê¥ûÁà∫Êπñ Êπñ„ÅÆÊ†ñ (The Lake Suite)', nights: 'Á¨¨ 7 Êôö', phone: '+81-142-82-4121' },
                    { name: 'Êú≠Âπå Forza (Hotel Forza)', nights: 'Á¨¨ 8 Êôö', phone: '+81-11-222-3555' },
                ];

                const foodRecommendations = {
                    'Ê†πÂÆ§Ëä±‰∏∏': 'ÂøÖÈªûÔºö‰∫åÂ±§Â∏ÜÁ´ãË≤ù„ÄÅËä±Âí≤ËüπÈêµÊ≥¢Ê±Å„ÄÅÁÇôÁáíÈÆ≠È≠ö',
                    'ÈÅîÊë©': 'ÂøÖÈªûÔºöÊàêÂêâÊÄùÊ±óÁÉ§ËÇâ„ÄÅ‰∏äËÇâ (Êï∏ÈáèÈôêÂÆö)„ÄÅËå∂Ê≥°È£Ø',
                    'ÊàêÂêâÊÄùÊ±ó': 'ÂøÖÈªûÔºöÊàêÂêâÊÄùÊ±óÁÉ§ËÇâ„ÄÅÂ∞èÁæäËÇâ',
                    '‰∏âËßíÂ∏ÇÂ†¥': 'ÂøÖÈªûÔºöÂ∏ùÁéãËüπ„ÄÅÊµ∑ËÜΩ‰∏º„ÄÅÊªùÊ≥¢È£üÂ†Ç/Ê≠¶Áî∞ÈÆÆÈ≠öÂ∫ó',
                    'Suage': 'ÂøÖÈªûÔºöÁü•Â∫äÈõûÈáéËèúÊπØÂíñÂì©„ÄÅÊüöÂ≠êËÉ°Ê§íÈ¢®Âë≥',
                    'ÊπØÂíñÂì©': 'ÂøÖÈªûÔºöÈõûËÖøÊπØÂíñÂì©„ÄÅÂä†Ëµ∑Âè∏È£Ø',
                    '‰∏ÄÂπª': 'ÂøÖÈªûÔºöÈÆÆËù¶Âë≥ÂôåÊãâÈ∫µ (ÈÅ©ÈáèË±öÈ™®/Á≤óÈ∫µ)„ÄÅËù¶‰ªÅÈ£ØÁ≥∞',
                    'ÊãâÈ∫µ': 'ÂøÖÈªûÔºöÂë≥ÂôåÊãâÈ∫µ„ÄÅÂ•∂Ê≤πÁéâÁ±≥ÊãâÈ∫µ',
                    'LeTAO': 'ÂøÖÈªûÔºöÈõôÂ±§ËäùÂ£´ËõãÁ≥ï (Double Fromage)„ÄÅÁ¥ÖËå∂Â∑ßÂÖãÂäõ',
                    'ÂåóËèìÊ®ì': 'ÂøÖÈªûÔºöÂ§¢‰∏çÊÄùË≠∞Ê≥°Ëäô„ÄÅÂ¶ñÁ≤æ‰πãÊ£ÆÂπ¥Ëº™ËõãÁ≥ï',
                    'ÂÖ≠Ëä±‰∫≠': 'ÂøÖÈªûÔºöËêäÂßÜËë°ËêÑÂ•∂Ê≤πÂ§æÂøÉÈ§Ö„ÄÅËçâËéìÂ∑ßÂÖãÂäõ',
                    'ÂΩ©Êú™': 'ÂøÖÈªûÔºöÂë≥ÂôåÊãâÈ∫µ (ÁîüËñëÈ¢®Âë≥)',
                    'ËüπÊú¨ÂÆ∂': 'ÂøÖÈªûÔºöËûÉËüπÊúÉÂ∏≠ÊñôÁêÜ„ÄÅÁÇ∏ËüπÊÆº',
                    'ÂÜ∞Èõ™‰πãÈñÄ': 'ÂøÖÈªûÔºöÂ∏ùÁéãËüπÂÖ®È§ê'
                };

                const activeTab = ref('itinerary');
                const loading = ref(false);
                const syncingExpenses = ref(false);
                const isSaving = ref(false);
                const isDeleting = ref(null);
                const itineraryData = ref([]);
                const weather = ref(null);
                const usingMockData = ref(false);
                const showExpenseModal = ref(false);
                const expenses = ref([]);
                const newExpense = ref({ amount: '', description: '', payer: 'IVAN' });
                const selectedDay = ref(null);
                const exchangeRate = ref(null);
                const calcHkd = ref('');
                const calcJpy = ref('');

                const fetchItinerary = () => {
                    loading.value = true;
                    if (!SHEET_CSV_URL) { useMockData(); return; }
                    Papa.parse(SHEET_CSV_URL, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (results) => {
                            const validData = results.data.filter(row => row.Date && row.Activity);
                            if(validData.length > 0) { 
                                itineraryData.value = validData; 
                                usingMockData.value = false;
                                const firstDay = validData[0]?.Date.trim();
                                if(firstDay) selectedDay.value = firstDay;
                            }
                            loading.value = false;
                        },
                        error: (err) => { console.error(err); loading.value = false; }
                    });
                };

                const useMockData = () => {
                    itineraryData.value = [{ Date: '2025/12/20', Time: '', Location: 'Êñ∞ÂçÉÊ≠≤Ê©üÂ†¥', Activity: 'ÊäµÈÅîÔºÅ', Note: 'ÁØÑ‰æãË≥áÊñô', Category: 'Transport', Link: '' }];
                    usingMockData.value = true;
                    loading.value = false;
                    selectedDay.value = '2025/12/20';
                };

                const fetchExpenses = async () => {
                    if (!APPS_SCRIPT_URL) return;
                    syncingExpenses.value = true;
                    try {
                        const res = await fetch(APPS_SCRIPT_URL);
                        const data = await res.json();
                        if (Array.isArray(data)) { expenses.value = data; }
                    } catch (e) { console.error("Sync error", e); } finally { syncingExpenses.value = false; }
                };

                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0618&longitude=141.3545&current_weather=true&daily=sunset&timezone=Asia%2FTokyo');
                        const data = await res.json();
                        weather.value = data;
                    } catch (e) { console.error(e); }
                };
                
                const fetchRate = async () => {
                    try {
                        const res = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
                        const data = await res.json();
                        exchangeRate.value = data.rates.JPY;
                    } catch (e) { console.error(e); }
                };
                
                const updateFromHkd = () => {
                    if(!exchangeRate.value || !calcHkd.value) { calcJpy.value = ''; return; }
                    calcJpy.value = (parseFloat(calcHkd.value) * exchangeRate.value).toFixed(0);
                };
                const updateFromJpy = () => {
                    if(!exchangeRate.value || !calcJpy.value) { calcHkd.value = ''; return; }
                    calcHkd.value = (parseFloat(calcJpy.value) / exchangeRate.value).toFixed(1);
                };

                const addExpense = async () => {
                    if (!newExpense.value.amount || !newExpense.value.description) return;
                    if (!APPS_SCRIPT_URL) { alert("Ë´ãÂÖàË®≠ÂÆö Apps Script Á∂≤ÂùÄÔºÅ"); return; }
                    isSaving.value = true;
                    const expenseData = { amount: parseInt(newExpense.value.amount), description: newExpense.value.description, payer: newExpense.value.payer };
                    try {
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(expenseData) });
                        expenses.value.unshift({ ...expenseData, date: new Date().toISOString(), id: 'temp-' + Date.now() });
                        newExpense.value = { amount: '', description: '', payer: 'IVAN' };
                        showExpenseModal.value = false;
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("ÂÑ≤Â≠òÂ§±Êïó"); } finally { isSaving.value = false; }
                };

                const deleteExpense = async (item) => {
                    if (!item.id) { alert("ÁÑ°Ê≥ïÂà™Èô§ËàäË≥áÊñô"); return; }
                    if (!confirm(`Âà™Èô§„Äå${item.description}„ÄçÔºü`)) return;
                    isDeleting.value = item.id;
                    try {
                        await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'delete', id: item.id }) });
                        expenses.value = expenses.value.filter(e => e.id !== item.id);
                        setTimeout(fetchExpenses, 2000);
                    } catch (e) { alert("Âà™Èô§Â§±Êïó"); } finally { isDeleting.value = null; }
                };

                const refreshAll = () => { fetchItinerary(); fetchExpenses(); fetchWeather(); fetchRate(); };

                const sunsetTime = computed(() => {
                    if (!weather.value || !weather.value.daily || !weather.value.daily.sunset) return '';
                    return weather.value.daily.sunset[0].split('T')[1];
                });

                const groupedItinerary = computed(() => {
                    const groups = {};
                    itineraryData.value.forEach(item => {
                        const dateKey = item.Date.trim();
                        if (!groups[dateKey]) groups[dateKey] = [];
                        groups[dateKey].push(item);
                    });
                    return Object.keys(groups).sort().reduce((acc, date) => { acc[date] = groups[date]; return acc; }, {});
                });
                
                const dateKeys = computed(() => Object.keys(groupedItinerary.value));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + (parseInt(item.amount)||0), 0));
                const getPersonTotal = (name) => { return expenses.value.filter(e => e.payer === name).reduce((sum, e) => sum + (parseInt(e.amount)||0), 0); };

                const getCategoryBorderClass = (cat) => {
                    if (!cat) return 'border-l-slate-300';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('È£ü')) return 'border-l-orange-400';
                    if (c.includes('transport') || c.includes('Ë°å') || c.includes('Ëªä')) return 'border-l-blue-400';
                    if (c.includes('sight') || c.includes('ÊôØ')) return 'border-l-emerald-400';
                    if (c.includes('shop') || c.includes('Ë≤∑')) return 'border-l-pink-400';
                    return 'border-l-[var(--color-primary)]';
                };

                const getCategoryIconClass = (cat) => {
                    if (!cat) return 'border-slate-200 text-slate-300 bg-slate-50';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('È£ü')) return 'border-orange-200 text-orange-400 bg-orange-50';
                    if (c.includes('transport') || c.includes('Ë°å') || c.includes('Ëªä')) return 'border-blue-200 text-blue-400 bg-blue-50';
                    if (c.includes('sight') || c.includes('ÊôØ')) return 'border-emerald-200 text-emerald-500 bg-emerald-50';
                    if (c.includes('shop') || c.includes('Ë≤∑')) return 'border-pink-200 text-pink-400 bg-pink-50';
                    return 'border-[var(--color-primary)] text-[var(--color-primary)] bg-sky-50';
                };

                const getCategoryIcon = (cat) => {
                    if (!cat) return 'fas fa-circle';
                    const c = cat.toLowerCase();
                    if (c.includes('food') || c.includes('È£ü')) return 'fas fa-utensils';
                    if (c.includes('transport') || c.includes('Ë°å') || c.includes('Ëªä')) return 'fas fa-train';
                    if (c.includes('sight') || c.includes('ÊôØ')) return 'fas fa-camera';
                    if (c.includes('shop') || c.includes('Ë≤∑')) return 'fas fa-shopping-bag';
                    return 'fas fa-map-pin';
                };

                const getFoodRecommendation = (item) => {
                    const cat = (item.Category || '').toLowerCase();
                    if (!cat.includes('food') && !cat.includes('È£ü')) return null;
                    const activity = (item.Activity || '').toLowerCase();
                    const location = (item.Location || '').toLowerCase();
                    const combinedText = activity + location;
                    if (combinedText.includes('Êó©È§ê') || combinedText.includes('breakfast')) {
                        if (!combinedText.includes('‰∫åÊ¢ù') && !combinedText.includes('‰∏âËßí')) return null;
                    }
                    for (const [key, recommend] of Object.entries(foodRecommendations)) {
                        if (combinedText.includes(key.toLowerCase())) {
                            return recommend;
                        }
                    }
                    return null;
                };

                const formatDate = (dateStr) => { try { const d = new Date(dateStr); return `${d.getMonth() + 1}Êúà${d.getDate()}Êó•`; } catch (e) { return dateStr; } };
                const formatShortDate = (dateStr) => { if(!dateStr) return ''; try { const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()}`; } catch (e) { return ''; } }
                const getDayOfWeek = (dateStr) => { try { return ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'][new Date(dateStr).getDay()]; } catch (e) { return ''; } };

                onMounted(() => { refreshAll(); });

                return {
                    people, activeTab, loading, weather, sunsetTime, groupedItinerary, dateKeys, selectedDay, expenses,
                    totalExpense, showExpenseModal, newExpense, addExpense, deleteExpense, refreshAll, syncingExpenses, isSaving, isDeleting,
                    formatDate, formatShortDate, getDayOfWeek, getCategoryBorderClass, getCategoryIconClass, getCategoryIcon, getFoodRecommendation,
                    SHEET_CSV_URL, APPS_SCRIPT_URL, getPersonTotal, usingMockData,
                    exchangeRate, calcHkd, calcJpy, updateFromHkd, updateFromJpy, hotelList
                };
            }
        }).mount('#app');
    </script>
</body>
</html>